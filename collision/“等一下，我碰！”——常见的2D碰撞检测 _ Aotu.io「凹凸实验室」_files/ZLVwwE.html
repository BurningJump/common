<!DOCTYPE html>
<!-- saved from url=(0172)https://codepen.io/JChehe/embed/ZLVwwE?height=517&theme-id=0&slug-hash=ZLVwwE&default-tab=result&user=JChehe&embed-version=2&pen-title=ray%20casting%20collision%20detection -->
<html lang="en" class="js pc"><!--<![endif]--><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

  

  <meta name="viewport" content="width=device-width">

  <title>CodePen Embed - ray casting collision detection</title>

  <meta name="csrf-param" content="authenticity_token">
<meta name="csrf-token" content="ZwXZS4vscOi0TrO71R5vaftVQHH1nSUkCM3lOVdOCUsDYW22hMI1+B1GKG54GaVB7SyDKpif9AImyQ42aT/VmQ==">

  <!-- STYLES -->
  <link rel="stylesheet" media="all" href="./embed-6fe83d38e291558fd5451d494fbfbd194507de48e28d816b36e5692dcba07652.css">

  <style>
    .hide {
      display: none !important;
    }
    .embed-nav {
      background: #3d3d3e;
      
    }
    .embed-nav ul a,
    .action-button {
      color: #ffffff;
      background-color: #666666;
    }
    .embed-nav ul a.active {
      background: #888888;
      color: #ffffff;
      box-shadow: inset 0px 3px #dddddd;
    }
    .embed-nav .logo-wrap a {
      color: #ffffff;
    }
    .embed-nav .cp-embed-logo, .embed-nav #icon-codepen-box {
      fill: #ffffff !important;
    }
  </style>

  <link rel="stylesheet" media="all" href="./twilight-2cb75eda672e6bf9b693686a681374f37c6ea158ece367b9833d6254e47dffe8.css">


  <script async="" src="./analytics.js.下载"></script>


</head>

<body onload="resizeEmbedWindow();" id="the-body" style="border: 1px solid #555555;" class="codepen-embed-body">

  <div class="embed-nav group" id="embed-nav">

  <ul class="code-types">

      <li class="code-type">
        <a id="html-link" href="https://codepen.io/JChehe/embed/ZLVwwE?height=517&amp;theme-id=0&amp;slug-hash=ZLVwwE&amp;default-tab=result&amp;user=JChehe&amp;embed-version=2&amp;pen-title=ray%20casting%20collision%20detection#html-box" aria-pressed="false" role="button">
          HTML
        </a>
      </li>

      <li class="code-type">
        <a id="css-link" href="https://codepen.io/JChehe/embed/ZLVwwE?height=517&amp;theme-id=0&amp;slug-hash=ZLVwwE&amp;default-tab=result&amp;user=JChehe&amp;embed-version=2&amp;pen-title=ray%20casting%20collision%20detection#css-box" aria-pressed="false" role="button">
          CSS
        </a>
      </li>

      <li class="code-type">
        <a id="js-link" href="https://codepen.io/JChehe/embed/ZLVwwE?height=517&amp;theme-id=0&amp;slug-hash=ZLVwwE&amp;default-tab=result&amp;user=JChehe&amp;embed-version=2&amp;pen-title=ray%20casting%20collision%20detection#js-box" aria-pressed="false" role="button">
          JS
        </a>
      </li>

    <li class="results results-type">
      <a id="result-link" href="https://codepen.io/JChehe/embed/ZLVwwE?height=517&amp;theme-id=0&amp;slug-hash=ZLVwwE&amp;default-tab=result&amp;user=JChehe&amp;embed-version=2&amp;pen-title=ray%20casting%20collision%20detection#result-box" class="active" aria-pressed="true" role="button">
        Result
      </a>
    </li>
  </ul>

  <div class="logo-wrap" id="edit-area">
    <a class="large-logo edit-on-codepen" target="_blank" rel="noopener" href="https://codepen.io/JChehe/pen/ZLVwwE" title="Edit on CodePen">
      <span id="edit-on-text" class="open-on">EDIT ON</span>
      <svg id="embed-codepen-logo" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0px" y="0px" width="411.438px" height="74.257px" viewBox="0 0 411.438 74.257" enable-background="new 0 0 411.438 74.257" xml:space="preserve">
  <g>
    <path class="cp-embed-logo" d="M25.857 18.232c4.618 0 8.85 1.67 12.14 4.429l4.472-5.33c-4.496-3.779-10.29-6.061-16.61-6.061 C11.6 11.27 0 22.87 0 37.128c0 14.26 11.6 25.86 25.86 25.856c6.32 0 12.114-2.282 16.61-6.061l-4.472-5.33 c-3.286 2.761-7.521 4.429-12.139 4.429c-10.419 0-18.896-8.476-18.896-18.894C6.962 26.71 15.44 18.23 25.86 18.232z"></path>
    <path class="cp-embed-logo" d="M168.993 12.763H155.07c-1.922 0-3.48 1.559-3.48 3.48v41.769c0 1.92 1.56 3.48 3.48 3.48h13.923 c13.436 0 24.365-10.93 24.365-24.365C193.358 23.69 182.43 12.76 168.99 12.763z M168.993 54.532h-10.442V19.725h10.442 c9.597 0 17.4 7.81 17.4 17.404C186.397 46.73 178.59 54.53 168.99 54.532z"></path>
    <path class="cp-embed-logo" d="M212.206 16.244v41.769c0 1.92 1.56 3.48 3.48 3.48h29.007v-6.961h-25.525V40.608h16.243v-6.961h-16.243 V19.725h25.525v-6.961h-29.007C213.765 12.76 212.21 14.32 212.21 16.244z"></path>
    <path class="cp-embed-logo" d="M317.569 16.244v41.769c0 1.92 1.56 3.48 3.48 3.48h29.006v-6.961H324.53V40.608h16.244v-6.961H324.53 V19.725h25.525v-6.961H321.05C319.128 12.76 317.57 14.32 317.57 16.244z"></path>
    <path class="cp-embed-logo" d="M284.443 12.763h-15.084c-1.922 0-3.48 1.559-3.48 3.48v45.25h6.962V40.608h11.603 c7.677 0 13.923-6.246 13.923-13.922C298.366 19.01 292.12 12.76 284.44 12.763z M284.443 33.647h-11.603V19.725h11.603 c3.839 0 6.96 3.12 6.96 6.961S288.282 33.65 284.44 33.647z"></path>
    <path class="cp-embed-logo" d="M404.476 12.763v35.636l-28.652-34.384c-0.938-1.127-2.481-1.545-3.859-1.045 c-1.378 0.5-2.296 1.808-2.296 3.273v45.25h6.962V25.858l28.652 34.383c0.675 0.81 1.66 1.25 2.67 1.25 c0.396 0 0.797-0.066 1.185-0.207c1.378-0.5 2.296-1.808 2.296-3.273v-45.25H404.476z"></path>
    <path class="cp-embed-logo" d="M131.815 25.261c-0.017-0.09-0.032-0.18-0.056-0.268c-0.015-0.053-0.033-0.103-0.05-0.155 c-0.025-0.078-0.051-0.156-0.082-0.232c-0.022-0.053-0.047-0.104-0.071-0.155c-0.034-0.072-0.069-0.143-0.109-0.212 c-0.028-0.051-0.06-0.099-0.091-0.148c-0.043-0.066-0.087-0.131-0.135-0.194c-0.035-0.047-0.071-0.092-0.109-0.137 c-0.05-0.06-0.104-0.117-0.158-0.173c-0.042-0.042-0.084-0.084-0.128-0.125c-0.058-0.053-0.118-0.103-0.181-0.151 c-0.048-0.037-0.095-0.075-0.145-0.109c-0.018-0.013-0.034-0.028-0.053-0.04L96.511 0.536c-1.071-0.715-2.468-0.715-3.539 0 L59.034 23.161c-0.019 0.012-0.034 0.027-0.053 0.04c-0.05 0.035-0.097 0.072-0.145 0.109c-0.062 0.049-0.123 0.099-0.181 0.15 c-0.044 0.04-0.086 0.082-0.127 0.125c-0.056 0.056-0.108 0.113-0.159 0.173c-0.038 0.045-0.074 0.09-0.109 0.14 c-0.048 0.063-0.092 0.127-0.135 0.194c-0.031 0.049-0.062 0.097-0.091 0.148c-0.04 0.069-0.075 0.14-0.108 0.21 c-0.024 0.051-0.05 0.103-0.071 0.155c-0.031 0.076-0.058 0.154-0.083 0.232c-0.017 0.052-0.035 0.103-0.049 0.15 c-0.023 0.088-0.04 0.177-0.056 0.268c-0.009 0.046-0.02 0.091-0.026 0.138c-0.018 0.138-0.028 0.276-0.028 0.417V48.44 c0 0.14 0.01 0.28 0.03 0.417c0.007 0.05 0.02 0.09 0.03 0.138c0.016 0.09 0.03 0.18 0.06 0.27 c0.014 0.05 0.03 0.1 0.05 0.155c0.025 0.08 0.05 0.16 0.08 0.233c0.021 0.05 0.05 0.1 0.07 0.15 c0.033 0.07 0.07 0.14 0.11 0.213c0.028 0.05 0.06 0.1 0.09 0.146c0.043 0.07 0.09 0.13 0.14 0.19 c0.035 0.05 0.07 0.09 0.11 0.138c0.051 0.06 0.1 0.12 0.16 0.173c0.041 0.04 0.08 0.09 0.13 0.12 c0.058 0.05 0.12 0.1 0.18 0.152c0.048 0.04 0.1 0.07 0.14 0.109c0.019 0.01 0.03 0.03 0.05 0.039L92.972 73.72 c0.536 0.36 1.15 0.54 1.77 0.537s1.234-0.18 1.77-0.537l33.938-22.625c0.019-0.012 0.035-0.026 0.053-0.039 c0.05-0.035 0.097-0.072 0.145-0.109c0.062-0.049 0.123-0.1 0.181-0.152c0.044-0.039 0.086-0.082 0.128-0.124 c0.055-0.056 0.108-0.113 0.158-0.173c0.038-0.045 0.074-0.09 0.109-0.138c0.048-0.063 0.092-0.128 0.135-0.194 c0.031-0.048 0.062-0.097 0.091-0.146c0.04-0.07 0.075-0.141 0.109-0.213c0.024-0.051 0.049-0.102 0.071-0.154 c0.031-0.077 0.057-0.155 0.082-0.233c0.017-0.052 0.035-0.103 0.05-0.155c0.023-0.088 0.039-0.178 0.056-0.268 c0.008-0.046 0.02-0.091 0.025-0.138c0.018-0.138 0.028-0.276 0.028-0.417V25.816c0-0.141-0.011-0.279-0.028-0.417 C131.835 25.35 131.82 25.31 131.81 25.261z M94.741 44.677l-11.285-7.548l11.285-7.549l11.286 7.549L94.741 44.677z M91.551 24.037L77.717 33.29L66.55 25.82L91.551 9.153V24.037z M71.978 37.128l-7.982 5.339V31.789L71.978 37.128z M77.717 40.97 l13.834 9.252v14.884L66.55 48.437L77.717 40.968z M97.932 50.22l13.834-9.252l11.168 7.469L97.932 65.104V50.22z M117.505 37.13 l7.983-5.34v10.679L117.505 37.128z M111.766 33.29l-13.834-9.252V9.153l25.002 16.667L111.766 33.29z"></path>
  </g>
</svg>
    </a>
    <a class="box-logo edit-on-codepen" target="_blank" rel="noopener" href="https://codepen.io/JChehe/pen/ZLVwwE" title="Edit on CodePen">
      <svg viewBox="0 0 100 100">
  <path id="icon-codepen-box" d="M99.961,34.205c-0.009-0.063-0.025-0.124-0.035-0.187c-0.021-0.121-0.043-0.242-0.075-0.36
    c-0.019-0.071-0.044-0.14-0.067-0.208c-0.034-0.105-0.068-0.21-0.11-0.312c-0.029-0.071-0.063-0.142-0.096-0.21
    c-0.045-0.097-0.092-0.192-0.146-0.284c-0.04-0.068-0.082-0.134-0.122-0.2c-0.058-0.089-0.117-0.176-0.182-0.26
    c-0.047-0.063-0.097-0.126-0.147-0.187c-0.068-0.079-0.139-0.158-0.214-0.232c-0.056-0.058-0.112-0.115-0.171-0.168
    c-0.079-0.071-0.161-0.14-0.243-0.205c-0.064-0.05-0.128-0.1-0.195-0.147c-0.025-0.016-0.047-0.037-0.071-0.053L52.383,0.722
    c-1.444-0.962-3.323-0.962-4.767,0L1.914,31.19c-0.024,0.016-0.046,0.037-0.071,0.053c-0.067,0.047-0.13,0.098-0.193,0.147
    c-0.084,0.065-0.166,0.134-0.243,0.205c-0.061,0.053-0.116,0.11-0.172,0.168c-0.075,0.074-0.146,0.153-0.213,0.232
    c-0.051,0.061-0.101,0.124-0.148,0.187c-0.063,0.084-0.124,0.171-0.18,0.26c-0.043,0.066-0.084,0.132-0.124,0.2
    c-0.053,0.092-0.1,0.187-0.146,0.284c-0.033,0.068-0.067,0.139-0.096,0.21c-0.042,0.103-0.076,0.208-0.11,0.312
    c-0.022,0.068-0.047,0.137-0.067,0.208c-0.031,0.119-0.052,0.239-0.075,0.36c-0.011,0.063-0.026,0.124-0.034,0.187
    C0.014,34.389,0,34.576,0,34.765v30.468c0,0.189,0.014,0.376,0.04,0.563c0.008,0.061,0.023,0.124,0.034,0.184
    c0.022,0.121,0.043,0.242,0.075,0.36c0.02,0.071,0.045,0.14,0.067,0.208c0.034,0.105,0.068,0.21,0.11,0.315
    c0.029,0.071,0.063,0.14,0.096,0.208c0.046,0.097,0.094,0.191,0.146,0.287c0.039,0.066,0.08,0.131,0.124,0.197
    c0.056,0.089,0.117,0.176,0.18,0.261c0.047,0.065,0.097,0.126,0.148,0.187c0.067,0.079,0.138,0.158,0.213,0.231
    c0.057,0.058,0.112,0.115,0.172,0.168c0.078,0.071,0.159,0.14,0.243,0.206c0.063,0.05,0.126,0.1,0.193,0.147
    c0.025,0.016,0.047,0.037,0.071,0.053l45.703,30.469C48.338,99.758,49.169,100,50,100c0.83,0,1.661-0.242,2.383-0.723
    l45.703-30.469c0.024-0.016,0.045-0.037,0.071-0.053c0.067-0.047,0.13-0.097,0.195-0.147c0.083-0.066,0.164-0.134,0.243-0.206
    c0.059-0.053,0.115-0.11,0.171-0.168c0.075-0.074,0.146-0.153,0.214-0.231c0.05-0.061,0.1-0.121,0.147-0.187
    c0.065-0.084,0.124-0.171,0.182-0.261c0.041-0.066,0.083-0.131,0.122-0.197c0.054-0.095,0.101-0.189,0.146-0.287
    c0.033-0.068,0.067-0.137,0.096-0.208c0.042-0.105,0.076-0.21,0.11-0.315c0.022-0.068,0.048-0.137,0.067-0.208
    c0.032-0.118,0.054-0.239,0.075-0.36c0.01-0.061,0.026-0.124,0.035-0.184C99.985,65.61,100,65.423,100,65.233V34.765
    C100,34.576,99.985,34.389,99.961,34.205z M54.297,12.327l33.668,22.444L72.927,44.831L54.297,32.369V12.327z M45.703,12.327
    v20.042L27.074,44.831l-15.04-10.061L45.703,12.327z M8.594,42.809L19.345,50L8.594,57.19V42.809z M45.703,87.672L12.035,65.228
    l15.04-10.058L45.703,67.63V87.672z M50,60.165L34.802,50L50,39.833L65.198,50L50,60.165z M54.297,87.672V67.63L72.927,55.17
    l15.039,10.058L54.297,87.672z M91.405,57.19L80.656,50l10.75-7.191V57.19z"></path>
</svg>
    </a>
  </div>

</div>

  <div id="output" class=" static" data-border-style="thin" data-header="true" style="height: calc(100% - 50px);">

      <div id="html-box" class="code-wrap code-box box " role="region" aria-label="HTML">


          <pre><code data-lang="xml" id="actual-html-code" data-og-lang="xml" data-alt-lang="xml" class=" cm-s-default"><span class="cm-comment">&lt;!-- 案例来自 《Canvas 核心技术》 --&gt;</span><br><br><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">canvas</span> <span class="cm-attribute">id</span>=<span class="cm-string">'canvas'</span> <span class="cm-attribute">width</span>=<span class="cm-string">'800'</span> <span class="cm-attribute">height</span>=<span class="cm-string">'450'</span><span class="cm-tag cm-bracket">&gt;</span><br>   Canvas not supported<br><span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">canvas</span><span class="cm-tag cm-bracket">&gt;</span><br><br><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">div</span> <span class="cm-attribute">id</span>=<span class="cm-string">'scoreboard'</span> <span class="cm-attribute">class</span>=<span class="cm-string">'floatingControls'</span><span class="cm-tag cm-bracket">&gt;</span>0<span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">div</span><span class="cm-tag cm-bracket">&gt;</span><br><br><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">div</span> <span class="cm-attribute">id</span>=<span class="cm-string">'controls'</span> <span class="cm-attribute">class</span>=<span class="cm-string">'floatingControls'</span><span class="cm-tag cm-bracket">&gt;</span><br>   启动速度  (m/s): <span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">output</span> <span class="cm-attribute">id</span>=<span class="cm-string">'launchVelocityOutput'</span><span class="cm-tag cm-bracket">&gt;</span><span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">output</span><span class="cm-tag cm-bracket">&gt;</span> m/s<span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">br</span><span class="cm-tag cm-bracket">/&gt;</span><br>   启动角度 (degrees): <span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">output</span> <span class="cm-attribute">id</span>=<span class="cm-string">'launchAngleOutput'</span><span class="cm-tag cm-bracket">&gt;</span><span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">output</span><span class="cm-tag cm-bracket">&gt;</span> 度<span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">br</span><span class="cm-tag cm-bracket">/&gt;</span><br><span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">div</span><span class="cm-tag cm-bracket">&gt;</span></code></pre>

      </div>

      <div id="css-box" class="code-wrap code-box box " role="region" aria-label="CSS">


          <pre><code data-lang="css" id="actual-css-code" data-og-lang="css" data-alt-lang="css" class=" cm-s-default">* {<br>    <span class="cm-property">margin</span>: <span class="cm-number">0</span>;<br>    <span class="cm-property">padding</span>: <span class="cm-number">0</span>;<br>}<br><br><span class="cm-tag">canvas</span> {<br>    <span class="cm-property">border</span>: <span class="cm-number">1px</span> <span class="cm-atom">solid</span> <span class="cm-keyword">orange</span>;<br>    <span class="cm-property">margin</span>: <span class="cm-number">0</span> <span class="cm-atom">auto</span>;<br>    <span class="cm-property">display</span>: <span class="cm-atom">block</span>;<br>}<br><br><span class="cm-tag">output</span> {<br>     <span class="cm-property">color</span>: <span class="cm-keyword">blue</span>;<br>  }<br><br>  <span class="cm-qualifier">.floatingControls</span> {<br>     <span class="cm-property">background</span>: <span class="cm-atom">rgba</span>(<span class="cm-number">0</span>, <span class="cm-number">0</span>, <span class="cm-number">0</span>, <span class="cm-number">0.1</span>);<br>     <span class="cm-property">border</span>: <span class="cm-atom">thin</span> <span class="cm-atom">solid</span> <span class="cm-keyword">skyblue</span>;<br>     <span class="cm-meta">-webkit-</span><span class="cm-property">box-shadow</span>: <span class="cm-atom">rgba</span>(<span class="cm-number">0</span>,<span class="cm-number">0</span>,<span class="cm-number">0</span>,<span class="cm-number">0.3</span>) <span class="cm-number">2px</span> <span class="cm-number">2px</span> <span class="cm-number">4px</span>;<br>     <span class="cm-meta">-moz-</span><span class="cm-property">box-shadow</span>: <span class="cm-atom">rgba</span>(<span class="cm-number">100</span>,<span class="cm-number">140</span>,<span class="cm-number">230</span>,<span class="cm-number">0.5</span>) <span class="cm-number">2px</span> <span class="cm-number">2px</span> <span class="cm-number">6px</span>;<br>     <span class="cm-property">box-shadow</span>: <span class="cm-atom">rgba</span>(<span class="cm-number">100</span>,<span class="cm-number">140</span>,<span class="cm-number">230</span>,<span class="cm-number">0.5</span>) <span class="cm-number">2px</span> <span class="cm-number">2px</span> <span class="cm-number">6px</span>;<br>     <span class="cm-property">padding</span>: <span class="cm-number">15px</span>;<br>     <span class="cm-property">font</span>: <span class="cm-number">12px</span> <span class="cm-variable">Arial</span>;<br>  }<br><br>  <span class="cm-builtin">#canvas</span> {<br>     <span class="cm-property">background</span>: <span class="cm-keyword">skyblue</span>;<br>     <span class="cm-meta">-webkit-</span><span class="cm-property">box-shadow</span>: <span class="cm-number">4px</span> <span class="cm-number">4px</span> <span class="cm-number">8px</span> <span class="cm-atom">rgba</span>(<span class="cm-number">0</span>,<span class="cm-number">0</span>,<span class="cm-number">0</span>,<span class="cm-number">0.5</span>);<br>     <span class="cm-meta">-moz-</span><span class="cm-property">box-shadow</span>: <span class="cm-number">4px</span> <span class="cm-number">4px</span> <span class="cm-number">8px</span> <span class="cm-atom">rgba</span>(<span class="cm-number">0</span>,<span class="cm-number">0</span>,<span class="cm-number">0</span>,<span class="cm-number">0.5</span>);<br>     <span class="cm-property">box-shadow</span>: <span class="cm-number">4px</span> <span class="cm-number">4px</span> <span class="cm-number">8px</span> <span class="cm-atom">rgba</span>(<span class="cm-number">0</span>,<span class="cm-number">0</span>,<span class="cm-number">0</span>,<span class="cm-number">0.5</span>);<br>     <span class="cm-property">cursor</span>: <span class="cm-atom">pointer</span>;<br>  }<br><br>  <span class="cm-builtin">#scoreboard</span> {<br>     <span class="cm-property">background</span>: <span class="cm-atom">rgba</span>(<span class="cm-number">255</span>,<span class="cm-number">255</span>,<span class="cm-number">255</span>,<span class="cm-number">0.5</span>);<br>     <span class="cm-property">position</span>: <span class="cm-atom">absolute</span>;<br>     <span class="cm-property">left</span>: <span class="cm-number">755px</span>;<br>     <span class="cm-property">top</span>: <span class="cm-number">20px</span>;<br>     <span class="cm-property">color</span>: <span class="cm-keyword">blue</span>;<br>     <span class="cm-property">font-size</span>: <span class="cm-number">18px</span>;<br>     <span class="cm-property">padding</span>: <span class="cm-number">5px</span>;<br>  }<br><br>  <span class="cm-builtin">#controls</span> {<br>     <span class="cm-property">position</span>: <span class="cm-atom">absolute</span>;<br>     <span class="cm-property">left</span>: <span class="cm-number">285px</span>;<br>     <span class="cm-property">top</span>: <span class="cm-number">20px</span>;<br>  }</code></pre>

      </div>


      <div id="js-box" class="code-wrap code-box box " role="region" aria-label="JS">


          <pre><code data-lang="" id="actual-js-code" data-og-lang="" data-alt-lang="javascript" class=" cm-s-default"><span class="cm-comment">/*</span><br><span class="cm-comment"> * Copyright (C) 2012 David Geary. This code is from the book</span><br><span class="cm-comment"> * Core HTML5 Canvas, published by Prentice-Hall in 2012.</span><br><span class="cm-comment"> *</span><br><span class="cm-comment"> * License:</span><br><span class="cm-comment"> *</span><br><span class="cm-comment"> * Permission is hereby granted, free of charge, to any person </span><br><span class="cm-comment"> * obtaining a copy of this software and associated documentation files</span><br><span class="cm-comment"> * (the "Software"), to deal in the Software without restriction,</span><br><span class="cm-comment"> * including without limitation the rights to use, copy, modify, merge,</span><br><span class="cm-comment"> * publish, distribute, sublicense, and/or sell copies of the Software,</span><br><span class="cm-comment"> * and to permit persons to whom the Software is furnished to do so,</span><br><span class="cm-comment"> * subject to the following conditions:</span><br><span class="cm-comment"> *</span><br><span class="cm-comment"> * The above copyright notice and this permission notice shall be</span><br><span class="cm-comment"> * included in all copies or substantial portions of the Software.</span><br><span class="cm-comment"> *</span><br><span class="cm-comment"> * The Software may not be used to create training material of any sort,</span><br><span class="cm-comment"> * including courses, books, instructional videos, presentations, etc.</span><br><span class="cm-comment"> * without the express written consent of David Geary.</span><br><span class="cm-comment"> *</span><br><span class="cm-comment"> * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,</span><br><span class="cm-comment"> * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES</span><br><span class="cm-comment"> * OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND</span><br><span class="cm-comment"> * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT</span><br><span class="cm-comment"> * HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,</span><br><span class="cm-comment"> * WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING</span><br><span class="cm-comment"> * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR</span><br><span class="cm-comment"> * OTHER DEALINGS IN THE SOFTWARE.</span><br><span class="cm-comment">*/</span><br><br><span class="cm-variable">window</span>.<span class="cm-property">requestNextAnimationFrame</span> <span class="cm-operator">=</span><br>   (<span class="cm-keyword">function</span> () {<br>      <span class="cm-keyword">var</span> <span class="cm-def">originalWebkitRequestAnimationFrame</span> <span class="cm-operator">=</span> <span class="cm-atom">undefined</span>,<br>          <span class="cm-def">wrapper</span> <span class="cm-operator">=</span> <span class="cm-atom">undefined</span>,<br>          <span class="cm-def">callback</span> <span class="cm-operator">=</span> <span class="cm-atom">undefined</span>,<br>          <span class="cm-def">geckoVersion</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>,<br>          <span class="cm-def">userAgent</span> <span class="cm-operator">=</span> <span class="cm-variable">navigator</span>.<span class="cm-property">userAgent</span>,<br>          <span class="cm-def">index</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>,<br>          <span class="cm-def">self</span> <span class="cm-operator">=</span> <span class="cm-keyword">this</span>;<br><br>      <span class="cm-comment">// Workaround for Chrome 10 bug where Chrome</span><br>      <span class="cm-comment">// does not pass the time to the animation function</span><br>      <br>      <span class="cm-keyword">if</span> (<span class="cm-variable">window</span>.<span class="cm-property">webkitRequestAnimationFrame</span>) {<br>         <span class="cm-comment">// Define the wrapper</span><br><br>         <span class="cm-variable-2">wrapper</span> <span class="cm-operator">=</span> <span class="cm-keyword">function</span> (<span class="cm-def">time</span>) {<br>           <span class="cm-keyword">if</span> (<span class="cm-variable-2">time</span> <span class="cm-operator">===</span> <span class="cm-atom">undefined</span>) {<br>              <span class="cm-variable-2">time</span> <span class="cm-operator">=</span> <span class="cm-operator">+</span><span class="cm-keyword">new</span> <span class="cm-variable">Date</span>();<br>           }<br>           <span class="cm-variable-2">self</span>.<span class="cm-property">callback</span>(<span class="cm-variable-2">time</span>);<br>         };<br><br>         <span class="cm-comment">// Make the switch</span><br>          <br>         <span class="cm-variable-2">originalWebkitRequestAnimationFrame</span> <span class="cm-operator">=</span> <span class="cm-variable">window</span>.<span class="cm-property">webkitRequestAnimationFrame</span>;    <br><br>         <span class="cm-variable">window</span>.<span class="cm-property">webkitRequestAnimationFrame</span> <span class="cm-operator">=</span> <span class="cm-keyword">function</span> (<span class="cm-def">callback</span>, <span class="cm-def">element</span>) {<br>            <span class="cm-variable-2">self</span>.<span class="cm-property">callback</span> <span class="cm-operator">=</span> <span class="cm-variable-2">callback</span>;<br><br>            <span class="cm-comment">// Browser calls the wrapper and wrapper calls the callback</span><br>            <br>            <span class="cm-variable-2">originalWebkitRequestAnimationFrame</span>(<span class="cm-variable-2">wrapper</span>, <span class="cm-variable-2">element</span>);<br>         }<br>      }<br><br>      <span class="cm-comment">// Workaround for Gecko 2.0, which has a bug in</span><br>      <span class="cm-comment">// mozRequestAnimationFrame() that restricts animations</span><br>      <span class="cm-comment">// to 30-40 fps.</span><br><br>      <span class="cm-keyword">if</span> (<span class="cm-variable">window</span>.<span class="cm-property">mozRequestAnimationFrame</span>) {<br>         <span class="cm-comment">// Check the Gecko version. Gecko is used by browsers</span><br>         <span class="cm-comment">// other than Firefox. Gecko 2.0 corresponds to</span><br>         <span class="cm-comment">// Firefox 4.0.</span><br>         <br>         <span class="cm-variable-2">index</span> <span class="cm-operator">=</span> <span class="cm-variable-2">userAgent</span>.<span class="cm-property">indexOf</span>(<span class="cm-string">'rv:'</span>);<br><br>         <span class="cm-keyword">if</span> (<span class="cm-variable-2">userAgent</span>.<span class="cm-property">indexOf</span>(<span class="cm-string">'Gecko'</span>) <span class="cm-operator">!=</span> <span class="cm-operator">-</span><span class="cm-number">1</span>) {<br>            <span class="cm-variable-2">geckoVersion</span> <span class="cm-operator">=</span> <span class="cm-variable-2">userAgent</span>.<span class="cm-property">substr</span>(<span class="cm-variable-2">index</span> <span class="cm-operator">+</span> <span class="cm-number">3</span>, <span class="cm-number">3</span>);<br><br>            <span class="cm-keyword">if</span> (<span class="cm-variable-2">geckoVersion</span> <span class="cm-operator">===</span> <span class="cm-string">'2.0'</span>) {<br>               <span class="cm-comment">// Forces the return statement to fall through</span><br>               <span class="cm-comment">// to the setTimeout() function.</span><br><br>               <span class="cm-variable">window</span>.<span class="cm-property">mozRequestAnimationFrame</span> <span class="cm-operator">=</span> <span class="cm-atom">undefined</span>;<br>            }<br>         }<br>      }<br>      <br>      <span class="cm-keyword">return</span> <span class="cm-variable">window</span>.<span class="cm-property">requestAnimationFrame</span>   <span class="cm-operator">||</span><br>         <span class="cm-variable">window</span>.<span class="cm-property">webkitRequestAnimationFrame</span> <span class="cm-operator">||</span><br>         <span class="cm-variable">window</span>.<span class="cm-property">mozRequestAnimationFrame</span>    <span class="cm-operator">||</span><br>         <span class="cm-variable">window</span>.<span class="cm-property">oRequestAnimationFrame</span>      <span class="cm-operator">||</span><br>         <span class="cm-variable">window</span>.<span class="cm-property">msRequestAnimationFrame</span>     <span class="cm-operator">||</span><br><br>         <span class="cm-keyword">function</span> (<span class="cm-def">callback</span>, <span class="cm-def">element</span>) {<br>            <span class="cm-keyword">var</span> <span class="cm-def">start</span>,<br>                <span class="cm-def">finish</span>;<br><br>            <span class="cm-variable">window</span>.<span class="cm-property">setTimeout</span>( <span class="cm-keyword">function</span> () {<br>               <span class="cm-variable-2">start</span> <span class="cm-operator">=</span> <span class="cm-operator">+</span><span class="cm-keyword">new</span> <span class="cm-variable">Date</span>();<br>               <span class="cm-variable-2">callback</span>(<span class="cm-variable-2">start</span>);<br>               <span class="cm-variable-2">finish</span> <span class="cm-operator">=</span> <span class="cm-operator">+</span><span class="cm-keyword">new</span> <span class="cm-variable">Date</span>();<br><br>               <span class="cm-variable-2">self</span>.<span class="cm-property">timeout</span> <span class="cm-operator">=</span> <span class="cm-number">1000</span> <span class="cm-operator">/</span> <span class="cm-number">60</span> <span class="cm-operator">-</span> (<span class="cm-variable-2">finish</span> <span class="cm-operator">-</span> <span class="cm-variable-2">start</span>);<br><br>            }, <span class="cm-variable-2">self</span>.<span class="cm-property">timeout</span>);<br>         };<br>      }<br>   )<br>();<br><br><br><span class="cm-comment">// sprite.js</span><br><br><span class="cm-keyword">var</span> <span class="cm-def">ImagePainter</span> <span class="cm-operator">=</span> <span class="cm-keyword">function</span> (<span class="cm-def">imageUrl</span>) {<br>   <span class="cm-keyword">this</span>.<span class="cm-property">image</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">Image</span>;<br>   <span class="cm-keyword">this</span>.<span class="cm-property">image</span>.<span class="cm-property">src</span> <span class="cm-operator">=</span> <span class="cm-variable-2">imageUrl</span>;<br>};<br><br><span class="cm-variable">ImagePainter</span>.<span class="cm-property">prototype</span> <span class="cm-operator">=</span> {<br>   <span class="cm-property">image</span>: <span class="cm-atom">undefined</span>,<br><br>   <span class="cm-property">paint</span>: <span class="cm-keyword">function</span> (<span class="cm-def">sprite</span>, <span class="cm-def">context</span>) {<br>      <span class="cm-keyword">if</span> (<span class="cm-keyword">this</span>.<span class="cm-property">image</span> <span class="cm-operator">!==</span> <span class="cm-atom">undefined</span>) {<br>         <span class="cm-keyword">if</span> ( <span class="cm-operator">!</span> <span class="cm-keyword">this</span>.<span class="cm-property">image</span>.<span class="cm-property">complete</span>) {<br>            <span class="cm-keyword">this</span>.<span class="cm-property">image</span>.<span class="cm-property">onload</span> <span class="cm-operator">=</span> <span class="cm-keyword">function</span> (<span class="cm-def">e</span>) {<br>               <span class="cm-variable-2">sprite</span>.<span class="cm-property">width</span> <span class="cm-operator">=</span> <span class="cm-keyword">this</span>.<span class="cm-property">width</span>;<br>               <span class="cm-variable-2">sprite</span>.<span class="cm-property">height</span> <span class="cm-operator">=</span> <span class="cm-keyword">this</span>.<span class="cm-property">height</span>;<br>               <br>               <span class="cm-variable-2">context</span>.<span class="cm-property">drawImage</span>(<span class="cm-keyword">this</span>,  <span class="cm-comment">// this is image</span><br>                  <span class="cm-variable-2">sprite</span>.<span class="cm-property">left</span>, <span class="cm-variable-2">sprite</span>.<span class="cm-property">top</span>,<br>                  <span class="cm-variable-2">sprite</span>.<span class="cm-property">width</span>, <span class="cm-variable-2">sprite</span>.<span class="cm-property">height</span>);<br>            };<br>         }<br>         <span class="cm-keyword">else</span> {<br>           <span class="cm-variable-2">context</span>.<span class="cm-property">drawImage</span>(<span class="cm-keyword">this</span>.<span class="cm-property">image</span>, <span class="cm-variable-2">sprite</span>.<span class="cm-property">left</span>, <span class="cm-variable-2">sprite</span>.<span class="cm-property">top</span>,<br>                             <span class="cm-variable-2">sprite</span>.<span class="cm-property">width</span>, <span class="cm-variable-2">sprite</span>.<span class="cm-property">height</span>); <br>         }<br>      }<br>   }<br>};<br><br><span class="cm-variable">SpriteSheetPainter</span> <span class="cm-operator">=</span> <span class="cm-keyword">function</span> (<span class="cm-def">cells</span>) {<br>   <span class="cm-keyword">this</span>.<span class="cm-property">cells</span> <span class="cm-operator">=</span> <span class="cm-variable-2">cells</span>;<br>};<br><br><span class="cm-variable">SpriteSheetPainter</span>.<span class="cm-property">prototype</span> <span class="cm-operator">=</span> {<br>   <span class="cm-property">cells</span>: [],<br>   <span class="cm-property">cellIndex</span>: <span class="cm-number">0</span>,<br><br>   <span class="cm-property">advance</span>: <span class="cm-keyword">function</span> () {<br>      <span class="cm-keyword">if</span> (<span class="cm-keyword">this</span>.<span class="cm-property">cellIndex</span> <span class="cm-operator">==</span> <span class="cm-keyword">this</span>.<span class="cm-property">cells</span>.<span class="cm-property">length</span><span class="cm-operator">-</span><span class="cm-number">1</span>) {<br>         <span class="cm-keyword">this</span>.<span class="cm-property">cellIndex</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<br>      }<br>      <span class="cm-keyword">else</span> {<br>         <span class="cm-keyword">this</span>.<span class="cm-property">cellIndex</span><span class="cm-operator">++</span>;<br>      }<br>   },<br>   <br>   <span class="cm-property">paint</span>: <span class="cm-keyword">function</span> (<span class="cm-def">sprite</span>, <span class="cm-def">context</span>) {<br>      <span class="cm-keyword">var</span> <span class="cm-def">cell</span> <span class="cm-operator">=</span> <span class="cm-keyword">this</span>.<span class="cm-property">cells</span>[<span class="cm-keyword">this</span>.<span class="cm-property">cellIndex</span>];<br>      <span class="cm-variable-2">context</span>.<span class="cm-property">drawImage</span>(<span class="cm-variable">spritesheet</span>, <span class="cm-variable-2">cell</span>.<span class="cm-property">left</span>, <span class="cm-variable-2">cell</span>.<span class="cm-property">top</span>,<br>                                     <span class="cm-variable-2">cell</span>.<span class="cm-property">width</span>, <span class="cm-variable-2">cell</span>.<span class="cm-property">height</span>,<br>                                     <span class="cm-variable-2">sprite</span>.<span class="cm-property">left</span>, <span class="cm-variable-2">sprite</span>.<span class="cm-property">top</span>,<br>                                     <span class="cm-variable-2">cell</span>.<span class="cm-property">width</span>, <span class="cm-variable-2">cell</span>.<span class="cm-property">height</span>);<br>   }<br>};<br><br><span class="cm-comment">// Sprite Animators...........................................................</span><br><br><span class="cm-comment">// Sprite animators have an array of painters that they succesively apply</span><br><span class="cm-comment">// to a sprite over a period of time. Animators can be started with </span><br><span class="cm-comment">// start(sprite, durationInMillis, restoreSprite)</span><br><br><span class="cm-keyword">var</span> <span class="cm-def">SpriteAnimator</span> <span class="cm-operator">=</span> <span class="cm-keyword">function</span> (<span class="cm-def">painters</span>, <span class="cm-def">elapsedCallback</span>) {<br>   <span class="cm-keyword">this</span>.<span class="cm-property">painters</span> <span class="cm-operator">=</span> <span class="cm-variable-2">painters</span>;<br>   <span class="cm-keyword">if</span> (<span class="cm-variable-2">elapsedCallback</span>) {<br>      <span class="cm-keyword">this</span>.<span class="cm-property">elapsedCallback</span> <span class="cm-operator">=</span> <span class="cm-variable-2">elapsedCallback</span>;<br>   }<br>};<br><br><span class="cm-variable">SpriteAnimator</span>.<span class="cm-property">prototype</span> <span class="cm-operator">=</span> {<br>   <span class="cm-property">painters</span>: [],<br>   <span class="cm-property">duration</span>: <span class="cm-number">1000</span>,<br>   <span class="cm-property">startTime</span>: <span class="cm-number">0</span>,<br>   <span class="cm-property">index</span>: <span class="cm-number">0</span>,<br>   <span class="cm-property">elapsedCallback</span>: <span class="cm-atom">undefined</span>,<br><br>   <span class="cm-property">end</span>: <span class="cm-keyword">function</span> (<span class="cm-def">sprite</span>, <span class="cm-def">originalPainter</span>) {<br>      <span class="cm-variable-2">sprite</span>.<span class="cm-property">animating</span> <span class="cm-operator">=</span> <span class="cm-atom">false</span>;<br><br>      <span class="cm-keyword">if</span> (<span class="cm-keyword">this</span>.<span class="cm-property">elapsedCallback</span>) {<br>         <span class="cm-keyword">this</span>.<span class="cm-property">elapsedCallback</span>(<span class="cm-variable-2">sprite</span>);<br>      }<br>      <span class="cm-keyword">else</span> {<br>         <span class="cm-variable-2">sprite</span>.<span class="cm-property">painter</span> <span class="cm-operator">=</span> <span class="cm-variable-2">originalPainter</span>;<br>      }              <br>   },<br>   <br>   <span class="cm-property">start</span>: <span class="cm-keyword">function</span> (<span class="cm-def">sprite</span>, <span class="cm-def">duration</span>) {<br>      <span class="cm-keyword">var</span> <span class="cm-def">endTime</span> <span class="cm-operator">=</span> <span class="cm-operator">+</span><span class="cm-keyword">new</span> <span class="cm-variable">Date</span>() <span class="cm-operator">+</span> <span class="cm-variable-2">duration</span>,<br>          <span class="cm-def">period</span> <span class="cm-operator">=</span> <span class="cm-variable-2">duration</span> <span class="cm-operator">/</span> (<span class="cm-keyword">this</span>.<span class="cm-property">painters</span>.<span class="cm-property">length</span>),<br>          <span class="cm-def">interval</span> <span class="cm-operator">=</span> <span class="cm-atom">undefined</span>,<br>          <span class="cm-def">animator</span> <span class="cm-operator">=</span> <span class="cm-keyword">this</span>, <span class="cm-comment">// for setInterval() function</span><br>          <span class="cm-def">originalPainter</span> <span class="cm-operator">=</span> <span class="cm-variable-2">sprite</span>.<span class="cm-property">painter</span>;<br><br>      <span class="cm-keyword">this</span>.<span class="cm-property">index</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<br>      <span class="cm-variable-2">sprite</span>.<span class="cm-property">animating</span> <span class="cm-operator">=</span> <span class="cm-atom">true</span>;<br>      <span class="cm-variable-2">sprite</span>.<span class="cm-property">painter</span> <span class="cm-operator">=</span> <span class="cm-keyword">this</span>.<span class="cm-property">painters</span>[<span class="cm-keyword">this</span>.<span class="cm-property">index</span>];<br><br>      <span class="cm-variable-2">interval</span> <span class="cm-operator">=</span> <span class="cm-variable">setInterval</span>(<span class="cm-keyword">function</span>() {<br>         <span class="cm-keyword">if</span> (<span class="cm-operator">+</span><span class="cm-keyword">new</span> <span class="cm-variable">Date</span>() <span class="cm-operator">&lt;</span> <span class="cm-variable-2">endTime</span>) {<br>            <span class="cm-variable-2">sprite</span>.<span class="cm-property">painter</span> <span class="cm-operator">=</span> <span class="cm-variable-2">animator</span>.<span class="cm-property">painters</span>[<span class="cm-operator">++</span><span class="cm-variable-2">animator</span>.<span class="cm-property">index</span>];<br>         }<br>         <span class="cm-keyword">else</span> {<br>            <span class="cm-variable-2">animator</span>.<span class="cm-property">end</span>(<span class="cm-variable-2">sprite</span>, <span class="cm-variable-2">originalPainter</span>);<br>            <span class="cm-variable">clearInterval</span>(<span class="cm-variable-2">interval</span>);<br>         }<br>      }, <span class="cm-variable-2">period</span>); <br>   },<br>};<br><br><span class="cm-comment">// Sprites....................................................................</span><br><br><span class="cm-comment">// Sprites have a name, a painter, and an array of behaviors. Sprites can</span><br><span class="cm-comment">// be updated, and painted.</span><br><span class="cm-comment">//</span><br><span class="cm-comment">// A sprite's painter paints the sprite: paint(sprite, context)</span><br><span class="cm-comment">// A sprite's behavior executes: execute(sprite, context, time)</span><br><br><span class="cm-keyword">var</span> <span class="cm-def">Sprite</span> <span class="cm-operator">=</span> <span class="cm-keyword">function</span> (<span class="cm-def">name</span>, <span class="cm-def">painter</span>, <span class="cm-def">behaviors</span>) {<br>   <span class="cm-keyword">if</span> (<span class="cm-variable-2">name</span> <span class="cm-operator">!==</span> <span class="cm-atom">undefined</span>)      <span class="cm-keyword">this</span>.<span class="cm-property">name</span> <span class="cm-operator">=</span> <span class="cm-variable-2">name</span>;<br>   <span class="cm-keyword">if</span> (<span class="cm-variable-2">painter</span> <span class="cm-operator">!==</span> <span class="cm-atom">undefined</span>)   <span class="cm-keyword">this</span>.<span class="cm-property">painter</span> <span class="cm-operator">=</span> <span class="cm-variable-2">painter</span>;<br>   <span class="cm-keyword">if</span> (<span class="cm-variable-2">behaviors</span> <span class="cm-operator">!==</span> <span class="cm-atom">undefined</span>) <span class="cm-keyword">this</span>.<span class="cm-property">behaviors</span> <span class="cm-operator">=</span> <span class="cm-variable-2">behaviors</span>;<br><br>   <span class="cm-keyword">return</span> <span class="cm-keyword">this</span>;<br>};<br><br><span class="cm-variable">Sprite</span>.<span class="cm-property">prototype</span> <span class="cm-operator">=</span> {<br>   <span class="cm-property">left</span>: <span class="cm-number">0</span>,<br>   <span class="cm-property">top</span>: <span class="cm-number">0</span>,<br>   <span class="cm-property">width</span>: <span class="cm-number">10</span>,<br>   <span class="cm-property">height</span>: <span class="cm-number">10</span>,<br>    <span class="cm-property">velocityX</span>: <span class="cm-number">0</span>,<br>    <span class="cm-property">velocityY</span>: <span class="cm-number">0</span>,<br>   <span class="cm-property">visible</span>: <span class="cm-atom">true</span>,<br>   <span class="cm-property">animating</span>: <span class="cm-atom">false</span>,<br>   <span class="cm-property">painter</span>: <span class="cm-atom">undefined</span>, <span class="cm-comment">// object with paint(sprite, context)</span><br>   <span class="cm-property">behaviors</span>: [], <span class="cm-comment">// objects with execute(sprite, context, time)</span><br><br>    <span class="cm-property">paint</span>: <span class="cm-keyword">function</span> (<span class="cm-def">context</span>) {<br>     <span class="cm-keyword">if</span> (<span class="cm-keyword">this</span>.<span class="cm-property">painter</span> <span class="cm-operator">!==</span> <span class="cm-atom">undefined</span> <span class="cm-operator">&amp;&amp;</span> <span class="cm-keyword">this</span>.<span class="cm-property">visible</span>) {<br>        <span class="cm-keyword">this</span>.<span class="cm-property">painter</span>.<span class="cm-property">paint</span>(<span class="cm-keyword">this</span>, <span class="cm-variable-2">context</span>);<br>     }<br>    },<br><br>   <span class="cm-property">update</span>: <span class="cm-keyword">function</span> (<span class="cm-def">context</span>, <span class="cm-def">time</span>) {<br>      <span class="cm-keyword">for</span> (<span class="cm-keyword">var</span> <span class="cm-def">i</span> <span class="cm-operator">=</span> <span class="cm-keyword">this</span>.<span class="cm-property">behaviors</span>.<span class="cm-property">length</span>; <span class="cm-variable-2">i</span> <span class="cm-operator">&gt;</span> <span class="cm-number">0</span>; <span class="cm-operator">--</span><span class="cm-variable-2">i</span>) {<br>         <span class="cm-keyword">this</span>.<span class="cm-property">behaviors</span>[<span class="cm-variable-2">i</span><span class="cm-operator">-</span><span class="cm-number">1</span>].<span class="cm-property">execute</span>(<span class="cm-keyword">this</span>, <span class="cm-variable-2">context</span>, <span class="cm-variable-2">time</span>);<br>      }<br>   }<br>};<br><br><span class="cm-comment">// 业务代码......</span><br><span class="cm-keyword">var</span> <span class="cm-def">canvas</span> <span class="cm-operator">=</span> <span class="cm-variable">document</span>.<span class="cm-property">getElementById</span>(<span class="cm-string">'canvas'</span>),<br>    <span class="cm-def">context</span> <span class="cm-operator">=</span> <span class="cm-variable">canvas</span>.<span class="cm-property">getContext</span>(<span class="cm-string">'2d'</span>),<br>    <span class="cm-def">scoreboard</span> <span class="cm-operator">=</span> <span class="cm-variable">document</span>.<span class="cm-property">getElementById</span>(<span class="cm-string">'scoreboard'</span>),<br>    <span class="cm-def">launchVelocityOutput</span> <span class="cm-operator">=</span> <span class="cm-variable">document</span>.<span class="cm-property">getElementById</span>(<span class="cm-string">'launchVelocityOutput'</span>),<br>    <span class="cm-def">launchAngleOutput</span> <span class="cm-operator">=</span> <span class="cm-variable">document</span>.<span class="cm-property">getElementById</span>(<span class="cm-string">'launchAngleOutput'</span>),<br><br>    <span class="cm-def">elapsedTime</span> <span class="cm-operator">=</span> <span class="cm-atom">undefined</span>,<br>    <span class="cm-def">launchTime</span> <span class="cm-operator">=</span> <span class="cm-atom">undefined</span>,<br><br>    <span class="cm-def">score</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>,<br>    <span class="cm-def">lastScore</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>,<br>    <span class="cm-def">lastMouse</span> <span class="cm-operator">=</span> { <span class="cm-property">left</span>: <span class="cm-number">0</span>, <span class="cm-property">top</span>: <span class="cm-number">0</span> },<br><br>    <span class="cm-def">threePointer</span> <span class="cm-operator">=</span> <span class="cm-atom">false</span>,<br>    <span class="cm-def">needInstructions</span> <span class="cm-operator">=</span> <span class="cm-atom">true</span>,<br><br>    <span class="cm-def">LAUNCHPAD_X</span> <span class="cm-operator">=</span> <span class="cm-number">50</span>,<br>    <span class="cm-def">LAUNCHPAD_Y</span> <span class="cm-operator">=</span> <span class="cm-variable">context</span>.<span class="cm-property">canvas</span>.<span class="cm-property">height</span><span class="cm-operator">-</span><span class="cm-number">50</span>,<br>    <span class="cm-def">LAUNCHPAD_WIDTH</span> <span class="cm-operator">=</span> <span class="cm-number">50</span>,<br>    <span class="cm-def">LAUNCHPAD_HEIGHT</span> <span class="cm-operator">=</span> <span class="cm-number">12</span>,<br>    <span class="cm-def">ARENA_LENGTH_IN_METERS</span> <span class="cm-operator">=</span> <span class="cm-number">10</span>,<br>    <span class="cm-def">INITIAL_LAUNCH_ANGLE</span> <span class="cm-operator">=</span> <span class="cm-variable">Math</span>.<span class="cm-property">PI</span><span class="cm-operator">/</span><span class="cm-number">4</span>,<br><br>    <span class="cm-def">launchAngle</span> <span class="cm-operator">=</span> <span class="cm-variable">INITIAL_LAUNCH_ANGLE</span>,<br>    <span class="cm-def">pixelsPerMeter</span> <span class="cm-operator">=</span> <span class="cm-variable">canvas</span>.<span class="cm-property">width</span> <span class="cm-operator">/</span> <span class="cm-variable">ARENA_LENGTH_IN_METERS</span>,<br><br>    <span class="cm-comment">// LaunchPad.................................................</span><br><br>    <span class="cm-def">launchPadPainter</span> <span class="cm-operator">=</span> {<br>      <span class="cm-property">LAUNCHPAD_FILL_STYLE</span>: <span class="cm-string">'rgb(100,140,230)'</span>,<br><br>      <span class="cm-property">paint</span>: <span class="cm-keyword">function</span> (<span class="cm-def">ledge</span>, <span class="cm-def">context</span>) { <br>         <span class="cm-variable-2">context</span>.<span class="cm-property">save</span>();<br>         <span class="cm-variable-2">context</span>.<span class="cm-property">fillStyle</span> <span class="cm-operator">=</span> <span class="cm-keyword">this</span>.<span class="cm-property">LAUNCHPAD_FILL_STYLE</span>;<br>         <span class="cm-variable-2">context</span>.<span class="cm-property">fillRect</span>(<span class="cm-variable">LAUNCHPAD_X</span>, <span class="cm-variable">LAUNCHPAD_Y</span>,<br>                          <span class="cm-variable">LAUNCHPAD_WIDTH</span>, <span class="cm-variable">LAUNCHPAD_HEIGHT</span>);<br>         <span class="cm-variable-2">context</span>.<span class="cm-property">restore</span>();<br>      }<br>    },<br><br>    <span class="cm-def">launchPad</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">Sprite</span>(<span class="cm-string">'launchPad'</span>, <span class="cm-variable">launchPadPainter</span>),<br><br>    <span class="cm-comment">// Ball......................................................</span><br><br>    <span class="cm-def">BALL_RADIUS</span> <span class="cm-operator">=</span> <span class="cm-number">8</span>,<br>    <span class="cm-def">lastBallPosition</span> <span class="cm-operator">=</span> { <span class="cm-property">left</span>: <span class="cm-number">0</span>, <span class="cm-property">top</span>: <span class="cm-number">0</span> },<br><br>    <span class="cm-def">ballPainter</span> <span class="cm-operator">=</span> {<br>      <span class="cm-property">BALL_FILL_STYLE</span>: <span class="cm-string">'rgb(255,255,0)'</span>,<br>      <span class="cm-property">BALL_STROKE_STYLE</span>: <span class="cm-string">'rgb(0,0,0,0.4)'</span>,<br>      <br>      <span class="cm-property">paint</span>: <span class="cm-keyword">function</span> (<span class="cm-def">ball</span>, <span class="cm-def">context</span>) { <br>         <span class="cm-variable-2">context</span>.<span class="cm-property">save</span>();<br>         <span class="cm-variable-2">context</span>.<span class="cm-property">shadowColor</span> <span class="cm-operator">=</span> <span class="cm-atom">undefined</span>;<br>         <span class="cm-variable-2">context</span>.<span class="cm-property">lineWidth</span> <span class="cm-operator">=</span> <span class="cm-number">2</span>;<br>         <span class="cm-variable-2">context</span>.<span class="cm-property">fillStyle</span> <span class="cm-operator">=</span> <span class="cm-keyword">this</span>.<span class="cm-property">BALL_FILL_STYLE</span>;<br>         <span class="cm-variable-2">context</span>.<span class="cm-property">strokeStyle</span> <span class="cm-operator">=</span> <span class="cm-keyword">this</span>.<span class="cm-property">BALL_STROKE_STYLE</span>;<br><br>         <span class="cm-variable-2">context</span>.<span class="cm-property">beginPath</span>();<br>         <span class="cm-variable-2">context</span>.<span class="cm-property">arc</span>(<span class="cm-variable-2">ball</span>.<span class="cm-property">left</span> <span class="cm-operator">+</span> <span class="cm-variable">BALL_RADIUS</span>, <span class="cm-variable-2">ball</span>.<span class="cm-property">top</span> <span class="cm-operator">+</span> <span class="cm-variable">BALL_RADIUS</span>,<br>                     <span class="cm-variable-2">ball</span>.<span class="cm-property">radius</span>, <span class="cm-number">0</span>, <span class="cm-variable">Math</span>.<span class="cm-property">PI</span><span class="cm-operator">*</span><span class="cm-number">2</span>, <span class="cm-atom">false</span>);<br><br>         <span class="cm-variable-2">context</span>.<span class="cm-property">clip</span>();<br>         <span class="cm-variable-2">context</span>.<span class="cm-property">fill</span>();<br>         <span class="cm-variable-2">context</span>.<span class="cm-property">stroke</span>();<br>         <span class="cm-variable-2">context</span>.<span class="cm-property">restore</span>();<br>      }<br>    },<br><br>    <span class="cm-comment">// Lob behavior..............................................</span><br>    <br>    <span class="cm-def">lob</span> <span class="cm-operator">=</span> {<br>       <span class="cm-property">lastTime</span>: <span class="cm-number">0</span>,<br>       <span class="cm-property">GRAVITY_FORCE</span>: <span class="cm-number">9.81</span>, <span class="cm-comment">// m/s/s</span><br>       <br>       <span class="cm-property">applyGravity</span>: <span class="cm-keyword">function</span> (<span class="cm-def">elapsed</span>) {<br>          <span class="cm-variable">ball</span>.<span class="cm-property">velocityY</span> <span class="cm-operator">=</span> (<span class="cm-keyword">this</span>.<span class="cm-property">GRAVITY_FORCE</span> <span class="cm-operator">*</span> <span class="cm-variable-2">elapsed</span>) <span class="cm-operator">-</span><br>                           (<span class="cm-variable">launchVelocity</span> <span class="cm-operator">*</span> <span class="cm-variable">Math</span>.<span class="cm-property">sin</span>(<span class="cm-variable">launchAngle</span>));<br>       },<br><br>       <span class="cm-property">updateBallPosition</span>: <span class="cm-keyword">function</span> (<span class="cm-def">updateDelta</span>) {<br>          <span class="cm-variable">lastBallPosition</span>.<span class="cm-property">left</span> <span class="cm-operator">=</span> <span class="cm-variable">ball</span>.<span class="cm-property">left</span>;<br>          <span class="cm-variable">lastBallPosition</span>.<span class="cm-property">top</span> <span class="cm-operator">=</span> <span class="cm-variable">ball</span>.<span class="cm-property">top</span>;<br><br>          <span class="cm-variable">ball</span>.<span class="cm-property">left</span> <span class="cm-operator">+=</span> <span class="cm-variable">ball</span>.<span class="cm-property">velocityX</span> <span class="cm-operator">*</span> (<span class="cm-variable-2">updateDelta</span>) <span class="cm-operator">*</span> <span class="cm-variable">pixelsPerMeter</span>;<br>          <span class="cm-variable">ball</span>.<span class="cm-property">top</span> <span class="cm-operator">+=</span> <span class="cm-variable">ball</span>.<span class="cm-property">velocityY</span> <span class="cm-operator">*</span> (<span class="cm-variable-2">updateDelta</span>) <span class="cm-operator">*</span> <span class="cm-variable">pixelsPerMeter</span>;<br>       },<br><br>       <span class="cm-property">checkForThreePointer</span>: <span class="cm-keyword">function</span> () {<br>          <span class="cm-keyword">if</span> (<span class="cm-variable">ball</span>.<span class="cm-property">top</span> <span class="cm-operator">&lt;</span> <span class="cm-number">0</span>) {<br>             <span class="cm-variable">threePointer</span> <span class="cm-operator">=</span> <span class="cm-atom">true</span>;<br>          }<br>       },<br><br>       <span class="cm-property">checkBallBounds</span>: <span class="cm-keyword">function</span> () {<br>          <span class="cm-keyword">if</span> (<span class="cm-variable">ball</span>.<span class="cm-property">top</span> <span class="cm-operator">&gt;</span> <span class="cm-variable">canvas</span>.<span class="cm-property">height</span> <span class="cm-operator">||</span> <span class="cm-variable">ball</span>.<span class="cm-property">left</span> <span class="cm-operator">&gt;</span> <span class="cm-variable">canvas</span>.<span class="cm-property">width</span>)  {<br>            <span class="cm-variable">reset</span>();<br>         }<br>       },<br>       <br>       <span class="cm-property">execute</span>: <span class="cm-keyword">function</span> (<span class="cm-def">ball</span>, <span class="cm-def">context</span>, <span class="cm-def">time</span>) {<br>          <span class="cm-keyword">var</span> <span class="cm-def">updateDelta</span>,<br>              <span class="cm-def">elapsedFlightTime</span>;<br><br>          <span class="cm-keyword">if</span> (<span class="cm-variable">ballInFlight</span>) {<br>             <span class="cm-variable">elapsedFrameTime</span>  <span class="cm-operator">=</span> (<span class="cm-variable-2">time</span> <span class="cm-operator">-</span> <span class="cm-keyword">this</span>.<span class="cm-property">lastTime</span>)<span class="cm-operator">/</span><span class="cm-number">1000</span>,<br>             <span class="cm-variable-2">elapsedFlightTime</span> <span class="cm-operator">=</span> (<span class="cm-variable-2">time</span> <span class="cm-operator">-</span> <span class="cm-variable">launchTime</span>)<span class="cm-operator">/</span><span class="cm-number">1000</span>;<br><br>             <span class="cm-keyword">this</span>.<span class="cm-property">applyGravity</span>(<span class="cm-variable-2">elapsedFlightTime</span>);<br>             <span class="cm-keyword">this</span>.<span class="cm-property">updateBallPosition</span>(<span class="cm-variable">elapsedFrameTime</span>);<br>             <span class="cm-keyword">this</span>.<span class="cm-property">checkForThreePointer</span>();<br>             <span class="cm-keyword">this</span>.<span class="cm-property">checkBallBounds</span>();<br>          }<br>          <span class="cm-keyword">this</span>.<span class="cm-property">lastTime</span> <span class="cm-operator">=</span> <span class="cm-variable-2">time</span>;<br>       }<br>    },<br>   <br>    <span class="cm-def">ball</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">Sprite</span>(<span class="cm-string">'ball'</span>, <span class="cm-variable">ballPainter</span>, [ <span class="cm-variable">lob</span> ]),<br>    <span class="cm-def">ballInFlight</span> <span class="cm-operator">=</span> <span class="cm-atom">false</span>,<br><br>    <span class="cm-comment">// Bucket....................................................</span><br><br>    <span class="cm-def">BUCKET_LEFT</span> <span class="cm-operator">=</span> <span class="cm-number">668</span>,<br>    <span class="cm-def">BUCKET_TOP</span> <span class="cm-operator">=</span> <span class="cm-variable">canvas</span>.<span class="cm-property">height</span> <span class="cm-operator">-</span> <span class="cm-number">100</span>,<br>    <span class="cm-def">BUCKET_WIDTH</span> <span class="cm-operator">=</span> <span class="cm-number">83</span>,<br>    <span class="cm-def">BUCKET_HEIGHT</span> <span class="cm-operator">=</span> <span class="cm-number">62</span>,<br>    <span class="cm-def">bucketHitCenter</span> <span class="cm-operator">=</span> { <span class="cm-property">x</span>: <span class="cm-variable">BUCKET_LEFT</span> <span class="cm-operator">+</span> <span class="cm-number">2</span><span class="cm-operator">*</span><span class="cm-keyword">this</span>.<span class="cm-property">BUCKET_WIDTH</span><span class="cm-operator">/</span><span class="cm-number">3</span>,<br>                        <span class="cm-property">y</span>: <span class="cm-variable">BUCKET_TOP</span> <span class="cm-operator">+</span> <span class="cm-variable">BUCKET_HEIGHT</span><span class="cm-operator">/</span><span class="cm-number">8</span><br>                      },<br><br>    <span class="cm-def">bucketHitRadius</span> <span class="cm-operator">=</span> <span class="cm-variable">BUCKET_WIDTH</span><span class="cm-operator">/</span><span class="cm-number">8</span>,<br>    <span class="cm-def">bucketImage</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">Image</span>(),<br><br>    <span class="cm-def">catchBall</span> <span class="cm-operator">=</span> {<br>       <span class="cm-property">intersectionPoint</span>: { <span class="cm-property">x</span>: <span class="cm-number">0</span>, <span class="cm-property">y</span>: <span class="cm-number">0</span> },<br><br>       <span class="cm-property">isBallInBucket</span>: <span class="cm-keyword">function</span>() {  <span class="cm-comment">// a posteriori</span><br>          <span class="cm-keyword">if</span> (<span class="cm-variable">lastBallPosition</span>.<span class="cm-property">left</span> <span class="cm-operator">===</span> <span class="cm-variable">ball</span>.<span class="cm-property">left</span> <span class="cm-operator">||</span><br>              <span class="cm-variable">lastBallPosition</span>.<span class="cm-property">top</span> <span class="cm-operator">===</span> <span class="cm-variable">ball</span>.<span class="cm-property">top</span>) {<br>             <span class="cm-keyword">return</span>;<br>          }<br><br>          <span class="cm-keyword">var</span> <span class="cm-def">x1</span> <span class="cm-operator">=</span> <span class="cm-variable">lastBallPosition</span>.<span class="cm-property">left</span>,<br>              <span class="cm-def">y1</span> <span class="cm-operator">=</span> <span class="cm-variable">lastBallPosition</span>.<span class="cm-property">top</span>,<br>              <span class="cm-def">x2</span> <span class="cm-operator">=</span> <span class="cm-variable">ball</span>.<span class="cm-property">left</span>,<br>              <span class="cm-def">y2</span> <span class="cm-operator">=</span> <span class="cm-variable">ball</span>.<span class="cm-property">top</span>,<br>              <span class="cm-def">x3</span> <span class="cm-operator">=</span> <span class="cm-variable">BUCKET_LEFT</span> <span class="cm-operator">+</span> <span class="cm-variable">BUCKET_WIDTH</span><span class="cm-operator">/</span><span class="cm-number">4</span>,<br>              <span class="cm-def">y3</span> <span class="cm-operator">=</span> <span class="cm-variable">BUCKET_TOP</span>,<br>              <span class="cm-def">x4</span> <span class="cm-operator">=</span> <span class="cm-variable">BUCKET_LEFT</span> <span class="cm-operator">+</span> <span class="cm-variable">BUCKET_WIDTH</span>,<br>              <span class="cm-def">y4</span> <span class="cm-operator">=</span> <span class="cm-variable-2">y3</span>,<br>              <span class="cm-def">m1</span> <span class="cm-operator">=</span> (<span class="cm-variable">ball</span>.<span class="cm-property">top</span> <span class="cm-operator">-</span> <span class="cm-variable">lastBallPosition</span>.<span class="cm-property">top</span>) <span class="cm-operator">/</span> (<span class="cm-variable">ball</span>.<span class="cm-property">left</span> <span class="cm-operator">-</span> <span class="cm-variable">lastBallPosition</span>.<span class="cm-property">left</span>),<br><br>              <span class="cm-def">m2</span> <span class="cm-operator">=</span> (<span class="cm-variable-2">y4</span> <span class="cm-operator">-</span> <span class="cm-variable-2">y3</span>) <span class="cm-operator">/</span> (<span class="cm-variable-2">x4</span> <span class="cm-operator">-</span> <span class="cm-variable-2">x3</span>), <span class="cm-comment">// zero, but calculate anyway for illustration</span><br><br>              <span class="cm-def">b1</span> <span class="cm-operator">=</span> <span class="cm-variable-2">y1</span> <span class="cm-operator">-</span> <span class="cm-variable-2">m1</span><span class="cm-operator">*</span><span class="cm-variable-2">x1</span>,<br>              <span class="cm-def">b2</span> <span class="cm-operator">=</span> <span class="cm-variable-2">y3</span> <span class="cm-operator">-</span> <span class="cm-variable-2">m2</span><span class="cm-operator">*</span><span class="cm-variable-2">x3</span>;<br><br>          <span class="cm-keyword">this</span>.<span class="cm-property">intersectionPoint</span>.<span class="cm-property">x</span> <span class="cm-operator">=</span> (<span class="cm-variable-2">b2</span> <span class="cm-operator">-</span> <span class="cm-variable-2">b1</span>) <span class="cm-operator">/</span> (<span class="cm-variable-2">m1</span> <span class="cm-operator">-</span> <span class="cm-variable-2">m2</span>);<br>          <span class="cm-keyword">this</span>.<span class="cm-property">intersectionPoint</span>.<span class="cm-property">y</span> <span class="cm-operator">=</span> <span class="cm-variable-2">m1</span><span class="cm-operator">*</span><span class="cm-keyword">this</span>.<span class="cm-property">intersectionPoint</span>.<span class="cm-property">x</span> <span class="cm-operator">+</span> <span class="cm-variable-2">b1</span>;<br><br>          <span class="cm-keyword">return</span> <span class="cm-keyword">this</span>.<span class="cm-property">intersectionPoint</span>.<span class="cm-property">x</span> <span class="cm-operator">&gt;</span> <span class="cm-variable-2">x3</span> <span class="cm-operator">&amp;&amp;</span> <br>                 <span class="cm-keyword">this</span>.<span class="cm-property">intersectionPoint</span>.<span class="cm-property">x</span> <span class="cm-operator">&lt;</span> <span class="cm-variable-2">x4</span> <span class="cm-operator">&amp;&amp;</span> <br>                 <span class="cm-variable">ball</span>.<span class="cm-property">top</span> <span class="cm-operator">+</span> <span class="cm-variable">ball</span>.<span class="cm-property">height</span> <span class="cm-operator">&gt;</span> <span class="cm-variable-2">y3</span> <span class="cm-operator">&amp;&amp;</span><br>                 <span class="cm-variable">ball</span>.<span class="cm-property">left</span> <span class="cm-operator">+</span> <span class="cm-variable">ball</span>.<span class="cm-property">width</span> <span class="cm-operator">&lt;</span> <span class="cm-variable-2">x4</span>;<br>        },<br> <br>        <span class="cm-property">adjustScore</span>: <span class="cm-keyword">function</span>() {<br>            <span class="cm-keyword">if</span> (<span class="cm-variable">threePointer</span>) <span class="cm-variable">lastScore</span> <span class="cm-operator">=</span> <span class="cm-number">3</span>;<br>            <span class="cm-keyword">else</span>              <span class="cm-variable">lastScore</span> <span class="cm-operator">=</span> <span class="cm-number">2</span>;<br> <br>            <span class="cm-variable">score</span> <span class="cm-operator">+=</span> <span class="cm-variable">lastScore</span>;<br>            <span class="cm-variable">scoreboard</span>.<span class="cm-property">innerText</span> <span class="cm-operator">=</span> <span class="cm-variable">score</span>;<br>        },<br><br>        <span class="cm-property">drawRay</span>: <span class="cm-keyword">function</span>() {<br>           <span class="cm-variable">context</span>.<span class="cm-property">beginPath</span>();<br>           <span class="cm-variable">context</span>.<span class="cm-property">save</span>();<br>           <span class="cm-variable">context</span>.<span class="cm-property">lineWidth</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>;<br>           <span class="cm-variable">context</span>.<span class="cm-property">strokeStyle</span> <span class="cm-operator">=</span> <span class="cm-string">'blue'</span>;<br>           <span class="cm-variable">context</span>.<span class="cm-property">moveTo</span>(<span class="cm-variable">ball</span>.<span class="cm-property">left</span> <span class="cm-operator">+</span> <span class="cm-variable">BALL_RADIUS</span>, <span class="cm-variable">ball</span>.<span class="cm-property">top</span> <span class="cm-operator">+</span> <span class="cm-variable">BALL_RADIUS</span>);<br>           <span class="cm-variable">context</span>.<span class="cm-property">lineTo</span>(<span class="cm-keyword">this</span>.<span class="cm-property">intersectionPoint</span>.<span class="cm-property">x</span>, <span class="cm-keyword">this</span>.<span class="cm-property">intersectionPoint</span>.<span class="cm-property">y</span>);<br>           <span class="cm-variable">context</span>.<span class="cm-property">stroke</span>();<br>           <span class="cm-variable">context</span>.<span class="cm-property">restore</span>();<br>        },<br><br>        <span class="cm-property">execute</span>: <span class="cm-keyword">function</span> (<span class="cm-def">bucket</span>, <span class="cm-def">context</span>, <span class="cm-def">time</span>) {<br>           <span class="cm-keyword">if</span> (<span class="cm-variable">ballInFlight</span>) {<br>              <span class="cm-keyword">this</span>.<span class="cm-property">drawRay</span>();<br><br>              <span class="cm-keyword">if</span> (<span class="cm-keyword">this</span>.<span class="cm-property">isBallInBucket</span>()) {<br>                 <span class="cm-variable">reset</span>();<br>                 <span class="cm-keyword">this</span>.<span class="cm-property">adjustScore</span>();<br>              }   <br>           }   <br>        }<br>     },<br> <br>     <span class="cm-def">bucket</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">Sprite</span>(<span class="cm-string">'bucket'</span>, {<br>          <span class="cm-property">paint</span>: <span class="cm-keyword">function</span> (<span class="cm-def">sprite</span>, <span class="cm-def">context</span>) {<br>             <span class="cm-variable-2">context</span>.<span class="cm-property">drawImage</span>(<span class="cm-variable">bucketImage</span>, <span class="cm-variable">BUCKET_LEFT</span>, <span class="cm-variable">BUCKET_TOP</span>);<br>          }<br>       },<br> <br>       [ <span class="cm-variable">catchBall</span> ]<br>     );<br>  <br><span class="cm-comment">// Functions.....................................................</span><br><br><span class="cm-keyword">function</span> <span class="cm-def">freeze</span>() {<br>   <span class="cm-variable">ball</span>.<span class="cm-property">velocityX</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<br>   <span class="cm-variable">ball</span>.<span class="cm-property">velocityY</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<br>   <span class="cm-variable">ballInFlight</span> <span class="cm-operator">=</span> <span class="cm-atom">false</span>;<br>   <span class="cm-variable">needInstructions</span> <span class="cm-operator">=</span> <span class="cm-atom">false</span>;<br>}<br><br><span class="cm-keyword">function</span> <span class="cm-def">reset</span>() {<br>   <span class="cm-variable">lastBallPosition</span>.<span class="cm-property">left</span> <span class="cm-operator">=</span> <span class="cm-variable">ball</span>.<span class="cm-property">left</span>;<br>   <span class="cm-variable">lastBallPosition</span>.<span class="cm-property">top</span> <span class="cm-operator">=</span> <span class="cm-variable">ball</span>.<span class="cm-property">top</span>;<br><br>   <span class="cm-variable">ball</span>.<span class="cm-property">left</span> <span class="cm-operator">=</span> <span class="cm-variable">LAUNCHPAD_X</span> <span class="cm-operator">+</span> <span class="cm-variable">LAUNCHPAD_WIDTH</span><span class="cm-operator">/</span><span class="cm-number">2</span> <span class="cm-operator">-</span> <span class="cm-variable">BALL_RADIUS</span>;<br>   <span class="cm-variable">ball</span>.<span class="cm-property">top</span> <span class="cm-operator">=</span> <span class="cm-variable">LAUNCHPAD_Y</span> <span class="cm-operator">-</span> <span class="cm-variable">ball</span>.<span class="cm-property">height</span><span class="cm-operator">/</span><span class="cm-number">2</span> <span class="cm-operator">-</span> <span class="cm-variable">BALL_RADIUS</span>;<br><br>   <span class="cm-variable">ball</span>.<span class="cm-property">velocityX</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<br>   <span class="cm-variable">ball</span>.<span class="cm-property">velocityY</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<br>   <span class="cm-variable">ballInFlight</span> <span class="cm-operator">=</span> <span class="cm-atom">false</span>;<br>   <span class="cm-variable">needInstructions</span> <span class="cm-operator">=</span> <span class="cm-atom">false</span>;<br>   <span class="cm-variable">lastScore</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<br>}<br><br><span class="cm-keyword">function</span> <span class="cm-def">showText</span>(<span class="cm-def">text</span>) {<br>   <span class="cm-keyword">var</span> <span class="cm-def">metrics</span>;<br><br>   <span class="cm-variable">context</span>.<span class="cm-property">font</span> <span class="cm-operator">=</span> <span class="cm-string">'42px Helvetica'</span>;<br>   <span class="cm-variable-2">metrics</span> <span class="cm-operator">=</span> <span class="cm-variable">context</span>.<span class="cm-property">measureText</span>(<span class="cm-variable-2">text</span>);<br><br>   <span class="cm-variable">context</span>.<span class="cm-property">save</span>();<br>   <span class="cm-variable">context</span>.<span class="cm-property">shadowColor</span> <span class="cm-operator">=</span> <span class="cm-atom">undefined</span>;<br>   <span class="cm-variable">context</span>.<span class="cm-property">strokeStyle</span> <span class="cm-operator">=</span> <span class="cm-string">'rgb(80,120,210)'</span>;<br>   <span class="cm-variable">context</span>.<span class="cm-property">fillStyle</span> <span class="cm-operator">=</span> <span class="cm-string">'rgba(100,140,230,0.5)'</span>;<br><br>   <span class="cm-variable">context</span>.<span class="cm-property">fillText</span>(<span class="cm-variable-2">text</span>,<br>                    <span class="cm-variable">canvas</span>.<span class="cm-property">width</span><span class="cm-operator">/</span><span class="cm-number">2</span> <span class="cm-operator">-</span> <span class="cm-variable-2">metrics</span>.<span class="cm-property">width</span><span class="cm-operator">/</span><span class="cm-number">2</span>,<br>                    <span class="cm-variable">canvas</span>.<span class="cm-property">height</span><span class="cm-operator">/</span><span class="cm-number">2</span>);<br><br>   <span class="cm-variable">context</span>.<span class="cm-property">strokeText</span>(<span class="cm-variable-2">text</span>,<br>                      <span class="cm-variable">canvas</span>.<span class="cm-property">width</span><span class="cm-operator">/</span><span class="cm-number">2</span> <span class="cm-operator">-</span> <span class="cm-variable-2">metrics</span>.<span class="cm-property">width</span><span class="cm-operator">/</span><span class="cm-number">2</span>,<br>                      <span class="cm-variable">canvas</span>.<span class="cm-property">height</span><span class="cm-operator">/</span><span class="cm-number">2</span>);<br>   <span class="cm-variable">context</span>.<span class="cm-property">restore</span>();<br>}<br><br><span class="cm-keyword">function</span> <span class="cm-def">drawRubberband</span>() {<br>   <span class="cm-variable">context</span>.<span class="cm-property">beginPath</span>();<br>   <span class="cm-variable">context</span>.<span class="cm-property">moveTo</span>(<span class="cm-variable">ball</span>.<span class="cm-property">left</span> <span class="cm-operator">+</span> <span class="cm-variable">BALL_RADIUS</span>, <span class="cm-variable">ball</span>.<span class="cm-property">top</span> <span class="cm-operator">+</span> <span class="cm-variable">BALL_RADIUS</span>);<br>   <span class="cm-variable">context</span>.<span class="cm-property">lineTo</span>(<span class="cm-variable">bucketHitCenter</span>.<span class="cm-property">x</span>, <span class="cm-variable">bucketHitCenter</span>.<span class="cm-property">y</span>);<br>   <span class="cm-variable">context</span>.<span class="cm-property">stroke</span>();<br>};<br><br><span class="cm-keyword">function</span> <span class="cm-def">drawGuidewire</span>() {<br>   <span class="cm-variable">context</span>.<span class="cm-property">moveTo</span>(<span class="cm-variable">ball</span>.<span class="cm-property">left</span> <span class="cm-operator">+</span> <span class="cm-variable">BALL_RADIUS</span>, <span class="cm-variable">ball</span>.<span class="cm-property">top</span> <span class="cm-operator">+</span> <span class="cm-variable">BALL_RADIUS</span>);<br>   <span class="cm-variable">context</span>.<span class="cm-property">lineTo</span>(<span class="cm-variable">lastMouse</span>.<span class="cm-property">left</span>, <span class="cm-variable">lastMouse</span>.<span class="cm-property">top</span>);<br>   <span class="cm-variable">context</span>.<span class="cm-property">stroke</span>();<br>};<br><br><span class="cm-keyword">function</span> <span class="cm-def">updateBackgroundText</span>() {<br>   <span class="cm-keyword">if</span> (<span class="cm-variable">lastScore</span> <span class="cm-operator">==</span> <span class="cm-number">3</span>)        <span class="cm-variable">showText</span>(<span class="cm-string">'三分!'</span>);<br>   <span class="cm-keyword">else</span> <span class="cm-keyword">if</span> (<span class="cm-variable">lastScore</span> <span class="cm-operator">==</span> <span class="cm-number">2</span>)   <span class="cm-variable">showText</span>(<span class="cm-string">'好球!'</span>);<br>   <span class="cm-keyword">else</span> <span class="cm-keyword">if</span> (<span class="cm-variable">needInstructions</span>) <span class="cm-variable">showText</span>(<span class="cm-string">'点击发球'</span>); <br>};<br><br><span class="cm-keyword">function</span> <span class="cm-def">resetScoreLater</span>() {<br>   <span class="cm-variable">setTimeout</span>(<span class="cm-keyword">function</span> () {<br>      <span class="cm-variable">lastScore</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<br>   }, <span class="cm-number">1000</span>);<br>};<br><br><span class="cm-keyword">function</span> <span class="cm-def">updateSprites</span>(<span class="cm-def">time</span>) {<br>   <span class="cm-variable">bucket</span>.<span class="cm-property">update</span>(<span class="cm-variable">context</span>, <span class="cm-variable-2">time</span>);<br>   <span class="cm-variable">launchPad</span>.<span class="cm-property">update</span>(<span class="cm-variable">context</span>, <span class="cm-variable-2">time</span>);<br>   <span class="cm-variable">ball</span>.<span class="cm-property">update</span>(<span class="cm-variable">context</span>, <span class="cm-variable-2">time</span>);<br>}<br><br><span class="cm-keyword">function</span> <span class="cm-def">paintSprites</span>() {<br>   <span class="cm-variable">launchPad</span>.<span class="cm-property">paint</span>(<span class="cm-variable">context</span>);<br>   <span class="cm-variable">bucket</span>.<span class="cm-property">paint</span>(<span class="cm-variable">context</span>);<br>   <span class="cm-variable">ball</span>.<span class="cm-property">paint</span>(<span class="cm-variable">context</span>);<br>}<br><br><span class="cm-keyword">function</span> <span class="cm-def">mouseToCanvas</span>(<span class="cm-def">e</span>) {<br>   <span class="cm-keyword">var</span> <span class="cm-def">rect</span> <span class="cm-operator">=</span> <span class="cm-variable">canvas</span>.<span class="cm-property">getBoundingClientRect</span>(),<br>       <span class="cm-def">loc</span> <span class="cm-operator">=</span> { <span class="cm-property">x</span>: <span class="cm-variable-2">e</span>.<span class="cm-property">x</span> <span class="cm-operator">||</span> <span class="cm-variable-2">e</span>.<span class="cm-property">clientX</span>,<br>               <span class="cm-property">y</span>: <span class="cm-variable-2">e</span>.<span class="cm-property">y</span> <span class="cm-operator">||</span> <span class="cm-variable-2">e</span>.<span class="cm-property">clientY</span><br>             };<br><br>   <span class="cm-variable-2">loc</span>.<span class="cm-property">x</span> <span class="cm-operator">-=</span> <span class="cm-variable-2">rect</span>.<span class="cm-property">left</span>;<br>   <span class="cm-variable-2">loc</span>.<span class="cm-property">y</span> <span class="cm-operator">-=</span> <span class="cm-variable-2">rect</span>.<span class="cm-property">top</span>;<br><br>   <span class="cm-keyword">return</span> <span class="cm-variable-2">loc</span>;<br>}<br><br><span class="cm-comment">// Event handlers................................................</span><br><span class="cm-keyword">var</span> <span class="cm-def">initTime</span> <span class="cm-operator">=</span> <span class="cm-operator">+</span><span class="cm-keyword">new</span> <span class="cm-variable">Date</span><br><span class="cm-variable">canvas</span>.<span class="cm-property">onmousedown</span> <span class="cm-operator">=</span> <span class="cm-keyword">function</span>(<span class="cm-def">e</span>) {<br>   <span class="cm-keyword">var</span> <span class="cm-def">rect</span>;<br><br>   <span class="cm-variable-2">e</span>.<span class="cm-property">preventDefault</span>();<br><br>   <span class="cm-keyword">if</span> ( <span class="cm-operator">!</span> <span class="cm-variable">ballInFlight</span>) {<br>     <span class="cm-variable">ball</span>.<span class="cm-property">velocityX</span> <span class="cm-operator">=</span> <span class="cm-variable">launchVelocity</span> <span class="cm-operator">*</span> <span class="cm-variable">Math</span>.<span class="cm-property">cos</span>(<span class="cm-variable">launchAngle</span>);<br>     <span class="cm-variable">ball</span>.<span class="cm-property">velocityY</span> <span class="cm-operator">=</span> <span class="cm-variable">launchVelocity</span> <span class="cm-operator">*</span> <span class="cm-variable">Math</span>.<span class="cm-property">sin</span>(<span class="cm-variable">launchAngle</span>);<br>     <span class="cm-variable">ballInFlight</span> <span class="cm-operator">=</span> <span class="cm-atom">true</span>;<br>     <span class="cm-variable">threePointer</span> <span class="cm-operator">=</span> <span class="cm-atom">false</span>;<br>     <span class="cm-variable">launchTime</span> <span class="cm-operator">=</span> <span class="cm-operator">+</span><span class="cm-keyword">new</span> <span class="cm-variable">Date</span>() <span class="cm-operator">-</span> <span class="cm-variable">initTime</span>;<br>   }<br>};<br><br><span class="cm-variable">canvas</span>.<span class="cm-property">onmousemove</span> <span class="cm-operator">=</span> <span class="cm-keyword">function</span> (<span class="cm-def">e</span>) {<br>   <span class="cm-keyword">var</span> <span class="cm-def">rect</span>;<br><br>   <span class="cm-variable-2">e</span>.<span class="cm-property">preventDefault</span>();<br><br>   <span class="cm-keyword">if</span> ( <span class="cm-operator">!</span> <span class="cm-variable">ballInFlight</span>) {<br>      <span class="cm-variable">loc</span> <span class="cm-operator">=</span> <span class="cm-variable">mouseToCanvas</span>(<span class="cm-variable-2">e</span>);<br>      <span class="cm-variable">lastMouse</span>.<span class="cm-property">left</span> <span class="cm-operator">=</span> <span class="cm-variable">loc</span>.<span class="cm-property">x</span>;<br>      <span class="cm-variable">lastMouse</span>.<span class="cm-property">top</span> <span class="cm-operator">=</span> <span class="cm-variable">loc</span>.<span class="cm-property">y</span>;<br><br>      <span class="cm-variable">deltaX</span> <span class="cm-operator">=</span> <span class="cm-variable">Math</span>.<span class="cm-property">abs</span>(<span class="cm-variable">lastMouse</span>.<span class="cm-property">left</span> <span class="cm-operator">-</span> <span class="cm-variable">ball</span>.<span class="cm-property">left</span>);<br>      <span class="cm-variable">deltaY</span> <span class="cm-operator">=</span> <span class="cm-variable">Math</span>.<span class="cm-property">abs</span>(<span class="cm-variable">lastMouse</span>.<span class="cm-property">top</span> <span class="cm-operator">-</span> <span class="cm-variable">ball</span>.<span class="cm-property">top</span>);<br><br>      <span class="cm-variable">launchAngle</span> <span class="cm-operator">=</span> <span class="cm-variable">Math</span>.<span class="cm-property">atan</span>(<span class="cm-variable">parseFloat</span>(<span class="cm-variable">deltaY</span>) <span class="cm-operator">/</span> <span class="cm-variable">parseFloat</span>(<span class="cm-variable">deltaX</span>));<br>      <span class="cm-variable">launchVelocity</span> <span class="cm-operator">=</span> <span class="cm-number">4</span> <span class="cm-operator">*</span> <span class="cm-variable">deltaY</span> <span class="cm-operator">/</span> <span class="cm-variable">Math</span>.<span class="cm-property">sin</span>(<span class="cm-variable">launchAngle</span>) <span class="cm-operator">/</span> <span class="cm-variable">pixelsPerMeter</span>;<br><br>      <span class="cm-variable">launchVelocityOutput</span>.<span class="cm-property">innerText</span> <span class="cm-operator">=</span> <span class="cm-variable">launchVelocity</span>.<span class="cm-property">toFixed</span>(<span class="cm-number">2</span>);<br>      <span class="cm-variable">launchAngleOutput</span>.<span class="cm-property">innerText</span> <span class="cm-operator">=</span> (<span class="cm-variable">launchAngle</span> <span class="cm-operator">*</span> <span class="cm-number">180</span><span class="cm-operator">/</span><span class="cm-variable">Math</span>.<span class="cm-property">PI</span>).<span class="cm-property">toFixed</span>(<span class="cm-number">2</span>);<br>   }<br>};<br><br><span class="cm-comment">// Animation Loop................................................</span><br><br><span class="cm-keyword">function</span> <span class="cm-def">animate</span>(<span class="cm-def">time</span>) {<br>   <span class="cm-variable">elapsedTime</span> <span class="cm-operator">=</span> (<span class="cm-variable-2">time</span> <span class="cm-operator">-</span> <span class="cm-variable">launchTime</span>) <span class="cm-operator">/</span> <span class="cm-number">1000</span>;<br>   <span class="cm-variable">context</span>.<span class="cm-property">clearRect</span>(<span class="cm-number">0</span>,<span class="cm-number">0</span>,<span class="cm-variable">canvas</span>.<span class="cm-property">width</span>,<span class="cm-variable">canvas</span>.<span class="cm-property">height</span>);<br><br>   <span class="cm-keyword">if</span> (<span class="cm-operator">!</span><span class="cm-variable">ballInFlight</span>) {<br>      <span class="cm-variable">drawGuidewire</span>();<br>      <span class="cm-variable">updateBackgroundText</span>();<br><br>      <span class="cm-keyword">if</span> (<span class="cm-variable">lastScore</span> <span class="cm-operator">!==</span> <span class="cm-number">0</span>) { <span class="cm-comment">// just scored</span><br>         <span class="cm-variable">resetScoreLater</span>();      <br>      }<br>   }<br><br>   <span class="cm-variable">paintSprites</span>();<br>   <span class="cm-variable">updateSprites</span>(<span class="cm-variable-2">time</span>);<br><br>   <span class="cm-comment">//drawRubberband();</span><br><br>   <span class="cm-variable">context</span>.<span class="cm-property">save</span>();<br>   <span class="cm-variable">context</span>.<span class="cm-property">beginPath</span>();<br>   <span class="cm-variable">context</span>.<span class="cm-property">lineWidth</span> <span class="cm-operator">=</span> <span class="cm-number">0.5</span>;<br>   <span class="cm-variable">context</span>.<span class="cm-property">strokeStyle</span> <span class="cm-operator">=</span> <span class="cm-string">'red'</span>;<br>   <span class="cm-variable">context</span>.<span class="cm-property">moveTo</span>(<span class="cm-number">0</span>, <span class="cm-variable">BUCKET_TOP</span><span class="cm-operator">+</span><span class="cm-number">0.5</span>);<br>   <span class="cm-variable">context</span>.<span class="cm-property">lineTo</span>(<span class="cm-variable">canvas</span>.<span class="cm-property">width</span>, <span class="cm-variable">BUCKET_TOP</span>);<br>   <span class="cm-variable">context</span>.<span class="cm-property">stroke</span>();<br>   <span class="cm-variable">context</span>.<span class="cm-property">restore</span>();<br>   <br>   <span class="cm-variable">window</span>.<span class="cm-property">requestNextAnimationFrame</span>(<span class="cm-variable">animate</span>);<br>}<br><br><span class="cm-comment">// Initialization................................................</span><br><br><span class="cm-variable">ball</span>.<span class="cm-property">width</span> <span class="cm-operator">=</span> <span class="cm-variable">BALL_RADIUS</span><span class="cm-operator">*</span><span class="cm-number">2</span>;<br><span class="cm-variable">ball</span>.<span class="cm-property">height</span> <span class="cm-operator">=</span> <span class="cm-variable">ball</span>.<span class="cm-property">width</span>;<br><span class="cm-variable">ball</span>.<span class="cm-property">left</span> <span class="cm-operator">=</span> <span class="cm-variable">LAUNCHPAD_X</span> <span class="cm-operator">+</span> <span class="cm-variable">LAUNCHPAD_WIDTH</span><span class="cm-operator">/</span><span class="cm-number">2</span> <span class="cm-operator">-</span> <span class="cm-variable">BALL_RADIUS</span>;<br><span class="cm-variable">ball</span>.<span class="cm-property">top</span> <span class="cm-operator">=</span> <span class="cm-variable">LAUNCHPAD_Y</span> <span class="cm-operator">-</span> <span class="cm-variable">ball</span>.<span class="cm-property">height</span><span class="cm-operator">/</span><span class="cm-number">2</span> <span class="cm-operator">-</span> <span class="cm-variable">BALL_RADIUS</span>;<br><span class="cm-variable">lastBallPosition</span>.<span class="cm-property">left</span> <span class="cm-operator">=</span> <span class="cm-variable">ball</span>.<span class="cm-property">left</span>;<br><span class="cm-variable">lastBallPosition</span>.<span class="cm-property">top</span> <span class="cm-operator">=</span> <span class="cm-variable">ball</span>.<span class="cm-property">top</span>;<br><span class="cm-variable">ball</span>.<span class="cm-property">radius</span> <span class="cm-operator">=</span> <span class="cm-variable">BALL_RADIUS</span>;<br> <br><span class="cm-variable">context</span>.<span class="cm-property">lineWidth</span> <span class="cm-operator">=</span> <span class="cm-number">0.5</span>;<br><span class="cm-variable">context</span>.<span class="cm-property">strokeStyle</span> <span class="cm-operator">=</span> <span class="cm-string">'rgba(0,0,0,0.5)'</span>;<br><span class="cm-variable">context</span>.<span class="cm-property">shadowColor</span> <span class="cm-operator">=</span> <span class="cm-string">'rgba(0,0,0,0.5)'</span>;<br><span class="cm-variable">context</span>.<span class="cm-property">shadowOffsetX</span> <span class="cm-operator">=</span> <span class="cm-number">2</span>;<br><span class="cm-variable">context</span>.<span class="cm-property">shadowOffsetY</span> <span class="cm-operator">=</span> <span class="cm-number">2</span>;<br><span class="cm-variable">context</span>.<span class="cm-property">shadowBlur</span> <span class="cm-operator">=</span> <span class="cm-number">4</span>; <br><span class="cm-variable">context</span>.<span class="cm-property">stroke</span>();<br><br><span class="cm-variable">bucketImage</span>.<span class="cm-property">onload</span> <span class="cm-operator">=</span> <span class="cm-keyword">function</span> (<span class="cm-def">e</span>) {<br>   <span class="cm-variable">bucket</span>.<span class="cm-property">left</span> <span class="cm-operator">=</span> <span class="cm-variable">BUCKET_LEFT</span>;<br>   <span class="cm-variable">bucket</span>.<span class="cm-property">top</span> <span class="cm-operator">=</span> <span class="cm-variable">BUCKET_TOP</span>;<br>   <span class="cm-variable">bucket</span>.<span class="cm-property">width</span> <span class="cm-operator">=</span> <span class="cm-variable">BUCKET_WIDTH</span>;<br>   <span class="cm-variable">bucket</span>.<span class="cm-property">height</span> <span class="cm-operator">=</span> <span class="cm-variable">BUCKET_HEIGHT</span>;<br>};<br><br><span class="cm-variable">animate</span>();<br><br><span class="cm-variable">bucketImage</span>.<span class="cm-property">src</span> <span class="cm-operator">=</span> <span class="cm-string">'data:image/png;base64,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'</span>;</code></pre>

      </div>

    <div id="result-box" class="code-box active" role="region" aria-label="Result">

      <iframe id="result-iframe" sandbox="allow-scripts allow-pointer-lock allow-same-origin allow-popups allow-modals allow-forms" src="./ZLVwwE(1).html" allowtransparency="true" frameborder="0" scrolling="yes" allowfullscreen="true" name="CodePen Preview for ray casting collision detection" title="CodePen Preview for ray casting collision detection" data-src="//s.codepen.io/JChehe/fullembedgrid/ZLVwwE?type=embed&amp;animations=run">
      </iframe>

      <a href="https://codepen.io/JChehe/embed/ZLVwwE?height=517&amp;theme-id=0&amp;slug-hash=ZLVwwE&amp;default-tab=result&amp;user=JChehe&amp;embed-version=2&amp;pen-title=ray%20casting%20collision%20detection#0" id="rerun-button" class="action-button rerun-button bottom right" onclick="EMBED.refreshResultIFrame(); return false;">
        Rerun
      </a>
    </div>

    
<div id="about-box">

  <div class="about-container">

    <div class="about-user">

      <div class="about-image" style="background-image: url(https://gravatar.com/avatar/7460ca1d282ff9f7adc112ad2f3b1e99?s=512&amp;d=https://codepen.io/assets/avatars/user-avatar-512x512-6e240cf350d2f1cc07c2bed234c3a3bb5f1b237023c204c782622e80d6b212ba.png)"></div>

      <div class="about-user-info">

        <p>
          This Pen is owned by <a href="https://codepen.io/JChehe" target="_blank">Jc</a> on CodePen.


          Check out @JChehe's
          <a href="https://codepen.io/JChehe" target="_blank" rel="noopener">
            12 Other Pens</a>
          .
        </p>

      </div>

    </div>

  </div>

</div>


  </div>


  <script>
    __processedPen = {"html":"&lt;!-- 案例来自 《Canvas 核心技术》 --&gt;\n\n&lt;canvas id=&#39;canvas&#39; width=&#39;800&#39; height=&#39;450&#39;&gt;\n   Canvas not supported\n&lt;/canvas&gt;\n\n&lt;div id=&#39;scoreboard&#39; class=&#39;floatingControls&#39;&gt;0&lt;/div&gt;\n\n&lt;div id=&#39;controls&#39; class=&#39;floatingControls&#39;&gt;\n   启动速度  (m/s): &lt;output id=&#39;launchVelocityOutput&#39;&gt;&lt;/output&gt; m/s&lt;br/&gt;\n   启动角度 (degrees): &lt;output id=&#39;launchAngleOutput&#39;&gt;&lt;/output&gt; 度&lt;br/&gt;\n&lt;/div&gt;","css":"* {\n\tmargin: 0;\n\tpadding: 0;\n}\n\ncanvas {\n\tborder: 1px solid orange;\n\tmargin: 0 auto;\n\tdisplay: block;\n}\n\noutput {\n     color: blue;\n  }\n\n  .floatingControls {\n     background: rgba(0, 0, 0, 0.1);\n     border: thin solid skyblue;\n     -webkit-box-shadow: rgba(0,0,0,0.3) 2px 2px 4px;\n     -moz-box-shadow: rgba(100,140,230,0.5) 2px 2px 6px;\n     box-shadow: rgba(100,140,230,0.5) 2px 2px 6px;\n     padding: 15px;\n     font: 12px Arial;\n  }\n\n  #canvas {\n     background: skyblue;\n     -webkit-box-shadow: 4px 4px 8px rgba(0,0,0,0.5);\n     -moz-box-shadow: 4px 4px 8px rgba(0,0,0,0.5);\n     box-shadow: 4px 4px 8px rgba(0,0,0,0.5);\n     cursor: pointer;\n  }\n\n  #scoreboard {\n     background: rgba(255,255,255,0.5);\n     position: absolute;\n     left: 755px;\n     top: 20px;\n     color: blue;\n     font-size: 18px;\n     padding: 5px;\n  }\n\n  #controls {\n     position: absolute;\n     left: 285px;\n     top: 20px;\n  }","js":"/*\n * Copyright (C) 2012 David Geary. This code is from the book\n * Core HTML5 Canvas, published by Prentice-Hall in 2012.\n *\n * License:\n *\n * Permission is hereby granted, free of charge, to any person \n * obtaining a copy of this software and associated documentation files\n * (the &quot;Software&quot;), to deal in the Software without restriction,\n * including without limitation the rights to use, copy, modify, merge,\n * publish, distribute, sublicense, and/or sell copies of the Software,\n * and to permit persons to whom the Software is furnished to do so,\n * subject to the following conditions:\n *\n * The above copyright notice and this permission notice shall be\n * included in all copies or substantial portions of the Software.\n *\n * The Software may not be used to create training material of any sort,\n * including courses, books, instructional videos, presentations, etc.\n * without the express written consent of David Geary.\n *\n * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,\n * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES\n * OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND\n * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT\n * HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,\n * WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING\n * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR\n * OTHER DEALINGS IN THE SOFTWARE.\n*/\n\nwindow.requestNextAnimationFrame =\n   (function () {\n      var originalWebkitRequestAnimationFrame = undefined,\n          wrapper = undefined,\n          callback = undefined,\n          geckoVersion = 0,\n          userAgent = navigator.userAgent,\n          index = 0,\n          self = this;\n\n      // Workaround for Chrome 10 bug where Chrome\n      // does not pass the time to the animation function\n      \n      if (window.webkitRequestAnimationFrame) {\n         // Define the wrapper\n\n         wrapper = function (time) {\n           if (time === undefined) {\n              time = +new Date();\n           }\n           self.callback(time);\n         };\n\n         // Make the switch\n          \n         originalWebkitRequestAnimationFrame = window.webkitRequestAnimationFrame;    \n\n         window.webkitRequestAnimationFrame = function (callback, element) {\n            self.callback = callback;\n\n            // Browser calls the wrapper and wrapper calls the callback\n            \n            originalWebkitRequestAnimationFrame(wrapper, element);\n         }\n      }\n\n      // Workaround for Gecko 2.0, which has a bug in\n      // mozRequestAnimationFrame() that restricts animations\n      // to 30-40 fps.\n\n      if (window.mozRequestAnimationFrame) {\n         // Check the Gecko version. Gecko is used by browsers\n         // other than Firefox. Gecko 2.0 corresponds to\n         // Firefox 4.0.\n         \n         index = userAgent.indexOf(&#39;rv:&#39;);\n\n         if (userAgent.indexOf(&#39;Gecko&#39;) != -1) {\n            geckoVersion = userAgent.substr(index + 3, 3);\n\n            if (geckoVersion === &#39;2.0&#39;) {\n               // Forces the return statement to fall through\n               // to the setTimeout() function.\n\n               window.mozRequestAnimationFrame = undefined;\n            }\n         }\n      }\n      \n      return window.requestAnimationFrame   ||\n         window.webkitRequestAnimationFrame ||\n         window.mozRequestAnimationFrame    ||\n         window.oRequestAnimationFrame      ||\n         window.msRequestAnimationFrame     ||\n\n         function (callback, element) {\n            var start,\n                finish;\n\n            window.setTimeout( function () {\n               start = +new Date();\n               callback(start);\n               finish = +new Date();\n\n               self.timeout = 1000 / 60 - (finish - start);\n\n            }, self.timeout);\n         };\n      }\n   )\n();\n\n\n// sprite.js\n\nvar ImagePainter = function (imageUrl) {\n   this.image = new Image;\n   this.image.src = imageUrl;\n};\n\nImagePainter.prototype = {\n   image: undefined,\n\n   paint: function (sprite, context) {\n      if (this.image !== undefined) {\n         if ( ! this.image.complete) {\n            this.image.onload = function (e) {\n               sprite.width = this.width;\n               sprite.height = this.height;\n               \n               context.drawImage(this,  // this is image\n                  sprite.left, sprite.top,\n                  sprite.width, sprite.height);\n            };\n         }\n         else {\n           context.drawImage(this.image, sprite.left, sprite.top,\n                             sprite.width, sprite.height); \n         }\n      }\n   }\n};\n\nSpriteSheetPainter = function (cells) {\n   this.cells = cells;\n};\n\nSpriteSheetPainter.prototype = {\n   cells: [],\n   cellIndex: 0,\n\n   advance: function () {\n      if (this.cellIndex == this.cells.length-1) {\n         this.cellIndex = 0;\n      }\n      else {\n         this.cellIndex++;\n      }\n   },\n   \n   paint: function (sprite, context) {\n      var cell = this.cells[this.cellIndex];\n      context.drawImage(spritesheet, cell.left, cell.top,\n                                     cell.width, cell.height,\n                                     sprite.left, sprite.top,\n                                     cell.width, cell.height);\n   }\n};\n\n// Sprite Animators...........................................................\n\n// Sprite animators have an array of painters that they succesively apply\n// to a sprite over a period of time. Animators can be started with \n// start(sprite, durationInMillis, restoreSprite)\n\nvar SpriteAnimator = function (painters, elapsedCallback) {\n   this.painters = painters;\n   if (elapsedCallback) {\n      this.elapsedCallback = elapsedCallback;\n   }\n};\n\nSpriteAnimator.prototype = {\n   painters: [],\n   duration: 1000,\n   startTime: 0,\n   index: 0,\n   elapsedCallback: undefined,\n\n   end: function (sprite, originalPainter) {\n      sprite.animating = false;\n\n      if (this.elapsedCallback) {\n         this.elapsedCallback(sprite);\n      }\n      else {\n         sprite.painter = originalPainter;\n      }              \n   },\n   \n   start: function (sprite, duration) {\n      var endTime = +new Date() + duration,\n          period = duration / (this.painters.length),\n          interval = undefined,\n          animator = this, // for setInterval() function\n          originalPainter = sprite.painter;\n\n      this.index = 0;\n      sprite.animating = true;\n      sprite.painter = this.painters[this.index];\n\n      interval = setInterval(function() {\n         if (+new Date() &lt; endTime) {\n            sprite.painter = animator.painters[++animator.index];\n         }\n         else {\n            animator.end(sprite, originalPainter);\n            clearInterval(interval);\n         }\n      }, period); \n   },\n};\n\n// Sprites....................................................................\n\n// Sprites have a name, a painter, and an array of behaviors. Sprites can\n// be updated, and painted.\n//\n// A sprite&#39;s painter paints the sprite: paint(sprite, context)\n// A sprite&#39;s behavior executes: execute(sprite, context, time)\n\nvar Sprite = function (name, painter, behaviors) {\n   if (name !== undefined)      this.name = name;\n   if (painter !== undefined)   this.painter = painter;\n   if (behaviors !== undefined) this.behaviors = behaviors;\n\n   return this;\n};\n\nSprite.prototype = {\n   left: 0,\n   top: 0,\n   width: 10,\n   height: 10,\n\tvelocityX: 0,\n\tvelocityY: 0,\n   visible: true,\n   animating: false,\n   painter: undefined, // object with paint(sprite, context)\n   behaviors: [], // objects with execute(sprite, context, time)\n\n\tpaint: function (context) {\n     if (this.painter !== undefined &amp;&amp; this.visible) {\n        this.painter.paint(this, context);\n     }\n\t},\n\n   update: function (context, time) {\n      for (var i = this.behaviors.length; i &gt; 0; --i) {\n         this.behaviors[i-1].execute(this, context, time);\n      }\n   }\n};\n\n// 业务代码......\nvar canvas = document.getElementById(&#39;canvas&#39;),\n    context = canvas.getContext(&#39;2d&#39;),\n    scoreboard = document.getElementById(&#39;scoreboard&#39;),\n    launchVelocityOutput = document.getElementById(&#39;launchVelocityOutput&#39;),\n    launchAngleOutput = document.getElementById(&#39;launchAngleOutput&#39;),\n\n    elapsedTime = undefined,\n    launchTime = undefined,\n\n    score = 0,\n    lastScore = 0,\n    lastMouse = { left: 0, top: 0 },\n\n    threePointer = false,\n    needInstructions = true,\n\n    LAUNCHPAD_X = 50,\n    LAUNCHPAD_Y = context.canvas.height-50,\n    LAUNCHPAD_WIDTH = 50,\n    LAUNCHPAD_HEIGHT = 12,\n    ARENA_LENGTH_IN_METERS = 10,\n    INITIAL_LAUNCH_ANGLE = Math.PI/4,\n\n    launchAngle = INITIAL_LAUNCH_ANGLE,\n    pixelsPerMeter = canvas.width / ARENA_LENGTH_IN_METERS,\n\n    // LaunchPad.................................................\n\n    launchPadPainter = {\n      LAUNCHPAD_FILL_STYLE: &#39;rgb(100,140,230)&#39;,\n\n      paint: function (ledge, context) { \n         context.save();\n         context.fillStyle = this.LAUNCHPAD_FILL_STYLE;\n         context.fillRect(LAUNCHPAD_X, LAUNCHPAD_Y,\n                          LAUNCHPAD_WIDTH, LAUNCHPAD_HEIGHT);\n         context.restore();\n      }\n    },\n\n    launchPad = new Sprite(&#39;launchPad&#39;, launchPadPainter),\n\n    // Ball......................................................\n\n    BALL_RADIUS = 8,\n    lastBallPosition = { left: 0, top: 0 },\n\n    ballPainter = {\n      BALL_FILL_STYLE: &#39;rgb(255,255,0)&#39;,\n      BALL_STROKE_STYLE: &#39;rgb(0,0,0,0.4)&#39;,\n      \n      paint: function (ball, context) { \n         context.save();\n         context.shadowColor = undefined;\n         context.lineWidth = 2;\n         context.fillStyle = this.BALL_FILL_STYLE;\n         context.strokeStyle = this.BALL_STROKE_STYLE;\n\n         context.beginPath();\n         context.arc(ball.left + BALL_RADIUS, ball.top + BALL_RADIUS,\n                     ball.radius, 0, Math.PI*2, false);\n\n         context.clip();\n         context.fill();\n         context.stroke();\n         context.restore();\n      }\n    },\n\n    // Lob behavior..............................................\n    \n    lob = {\n       lastTime: 0,\n       GRAVITY_FORCE: 9.81, // m/s/s\n       \n       applyGravity: function (elapsed) {\n          ball.velocityY = (this.GRAVITY_FORCE * elapsed) -\n                           (launchVelocity * Math.sin(launchAngle));\n       },\n\n       updateBallPosition: function (updateDelta) {\n          lastBallPosition.left = ball.left;\n          lastBallPosition.top = ball.top;\n\n          ball.left += ball.velocityX * (updateDelta) * pixelsPerMeter;\n          ball.top += ball.velocityY * (updateDelta) * pixelsPerMeter;\n       },\n\n       checkForThreePointer: function () {\n          if (ball.top &lt; 0) {\n             threePointer = true;\n          }\n       },\n\n       checkBallBounds: function () {\n          if (ball.top &gt; canvas.height || ball.left &gt; canvas.width)  {\n            reset();\n         }\n       },\n       \n       execute: function (ball, context, time) {\n          var updateDelta,\n              elapsedFlightTime;\n\n          if (ballInFlight) {\n             elapsedFrameTime  = (time - this.lastTime)/1000,\n             elapsedFlightTime = (time - launchTime)/1000;\n\n             this.applyGravity(elapsedFlightTime);\n             this.updateBallPosition(elapsedFrameTime);\n             this.checkForThreePointer();\n             this.checkBallBounds();\n          }\n          this.lastTime = time;\n       }\n    },\n   \n    ball = new Sprite(&#39;ball&#39;, ballPainter, [ lob ]),\n    ballInFlight = false,\n\n    // Bucket....................................................\n\n    BUCKET_LEFT = 668,\n    BUCKET_TOP = canvas.height - 100,\n    BUCKET_WIDTH = 83,\n    BUCKET_HEIGHT = 62,\n    bucketHitCenter = { x: BUCKET_LEFT + 2*this.BUCKET_WIDTH/3,\n                        y: BUCKET_TOP + BUCKET_HEIGHT/8\n                      },\n\n    bucketHitRadius = BUCKET_WIDTH/8,\n    bucketImage = new Image(),\n\n    catchBall = {\n       intersectionPoint: { x: 0, y: 0 },\n\n       isBallInBucket: function() {  // a posteriori\n          if (lastBallPosition.left === ball.left ||\n              lastBallPosition.top === ball.top) {\n             return;\n          }\n\n          var x1 = lastBallPosition.left,\n              y1 = lastBallPosition.top,\n              x2 = ball.left,\n              y2 = ball.top,\n              x3 = BUCKET_LEFT + BUCKET_WIDTH/4,\n              y3 = BUCKET_TOP,\n              x4 = BUCKET_LEFT + BUCKET_WIDTH,\n              y4 = y3,\n              m1 = (ball.top - lastBallPosition.top) / (ball.left - lastBallPosition.left),\n\n              m2 = (y4 - y3) / (x4 - x3), // zero, but calculate anyway for illustration\n\n              b1 = y1 - m1*x1,\n              b2 = y3 - m2*x3;\n\n          this.intersectionPoint.x = (b2 - b1) / (m1 - m2);\n          this.intersectionPoint.y = m1*this.intersectionPoint.x + b1;\n\n          return this.intersectionPoint.x &gt; x3 &amp;&amp; \n                 this.intersectionPoint.x &lt; x4 &amp;&amp; \n                 ball.top + ball.height &gt; y3 &amp;&amp;\n                 ball.left + ball.width &lt; x4;\n        },\n \n        adjustScore: function() {\n            if (threePointer) lastScore = 3;\n            else              lastScore = 2;\n \n            score += lastScore;\n            scoreboard.innerText = score;\n        },\n\n        drawRay: function() {\n           context.beginPath();\n           context.save();\n           context.lineWidth = 1;\n           context.strokeStyle = &#39;blue&#39;;\n           context.moveTo(ball.left + BALL_RADIUS, ball.top + BALL_RADIUS);\n           context.lineTo(this.intersectionPoint.x, this.intersectionPoint.y);\n           context.stroke();\n           context.restore();\n        },\n\n        execute: function (bucket, context, time) {\n           if (ballInFlight) {\n              this.drawRay();\n\n              if (this.isBallInBucket()) {\n                 reset();\n                 this.adjustScore();\n              }   \n           }   \n        }\n     },\n \n     bucket = new Sprite(&#39;bucket&#39;, {\n          paint: function (sprite, context) {\n             context.drawImage(bucketImage, BUCKET_LEFT, BUCKET_TOP);\n          }\n       },\n \n       [ catchBall ]\n     );\n  \n// Functions.....................................................\n\nfunction freeze() {\n   ball.velocityX = 0;\n   ball.velocityY = 0;\n   ballInFlight = false;\n   needInstructions = false;\n}\n\nfunction reset() {\n   lastBallPosition.left = ball.left;\n   lastBallPosition.top = ball.top;\n\n   ball.left = LAUNCHPAD_X + LAUNCHPAD_WIDTH/2 - BALL_RADIUS;\n   ball.top = LAUNCHPAD_Y - ball.height/2 - BALL_RADIUS;\n\n   ball.velocityX = 0;\n   ball.velocityY = 0;\n   ballInFlight = false;\n   needInstructions = false;\n   lastScore = 0;\n}\n\nfunction showText(text) {\n   var metrics;\n\n   context.font = &#39;42px Helvetica&#39;;\n   metrics = context.measureText(text);\n\n   context.save();\n   context.shadowColor = undefined;\n   context.strokeStyle = &#39;rgb(80,120,210)&#39;;\n   context.fillStyle = &#39;rgba(100,140,230,0.5)&#39;;\n\n   context.fillText(text,\n                    canvas.width/2 - metrics.width/2,\n                    canvas.height/2);\n\n   context.strokeText(text,\n                      canvas.width/2 - metrics.width/2,\n                      canvas.height/2);\n   context.restore();\n}\n\nfunction drawRubberband() {\n   context.beginPath();\n   context.moveTo(ball.left + BALL_RADIUS, ball.top + BALL_RADIUS);\n   context.lineTo(bucketHitCenter.x, bucketHitCenter.y);\n   context.stroke();\n};\n\nfunction drawGuidewire() {\n   context.moveTo(ball.left + BALL_RADIUS, ball.top + BALL_RADIUS);\n   context.lineTo(lastMouse.left, lastMouse.top);\n   context.stroke();\n};\n\nfunction updateBackgroundText() {\n   if (lastScore == 3)        showText(&#39;三分!&#39;);\n   else if (lastScore == 2)   showText(&#39;好球!&#39;);\n   else if (needInstructions) showText(&#39;点击发球&#39;); \n};\n\nfunction resetScoreLater() {\n   setTimeout(function () {\n      lastScore = 0;\n   }, 1000);\n};\n\nfunction updateSprites(time) {\n   bucket.update(context, time);\n   launchPad.update(context, time);\n   ball.update(context, time);\n}\n\nfunction paintSprites() {\n   launchPad.paint(context);\n   bucket.paint(context);\n   ball.paint(context);\n}\n\nfunction mouseToCanvas(e) {\n   var rect = canvas.getBoundingClientRect(),\n       loc = { x: e.x || e.clientX,\n               y: e.y || e.clientY\n             };\n\n   loc.x -= rect.left;\n   loc.y -= rect.top;\n\n   return loc;\n}\n\n// Event handlers................................................\nvar initTime = +new Date\ncanvas.onmousedown = function(e) {\n   var rect;\n\n   e.preventDefault();\n\n   if ( ! ballInFlight) {\n     ball.velocityX = launchVelocity * Math.cos(launchAngle);\n     ball.velocityY = launchVelocity * Math.sin(launchAngle);\n     ballInFlight = true;\n     threePointer = false;\n     launchTime = +new Date() - initTime;\n   }\n};\n\ncanvas.onmousemove = function (e) {\n   var rect;\n\n   e.preventDefault();\n\n   if ( ! ballInFlight) {\n      loc = mouseToCanvas(e);\n      lastMouse.left = loc.x;\n      lastMouse.top = loc.y;\n\n      deltaX = Math.abs(lastMouse.left - ball.left);\n      deltaY = Math.abs(lastMouse.top - ball.top);\n\n      launchAngle = Math.atan(parseFloat(deltaY) / parseFloat(deltaX));\n      launchVelocity = 4 * deltaY / Math.sin(launchAngle) / pixelsPerMeter;\n\n      launchVelocityOutput.innerText = launchVelocity.toFixed(2);\n      launchAngleOutput.innerText = (launchAngle * 180/Math.PI).toFixed(2);\n   }\n};\n\n// Animation Loop................................................\n\nfunction animate(time) {\n   elapsedTime = (time - launchTime) / 1000;\n   context.clearRect(0,0,canvas.width,canvas.height);\n\n   if (!ballInFlight) {\n      drawGuidewire();\n      updateBackgroundText();\n\n      if (lastScore !== 0) { // just scored\n         resetScoreLater();      \n      }\n   }\n\n   paintSprites();\n   updateSprites(time);\n\n   //drawRubberband();\n\n   context.save();\n   context.beginPath();\n   context.lineWidth = 0.5;\n   context.strokeStyle = &#39;red&#39;;\n   context.moveTo(0, BUCKET_TOP+0.5);\n   context.lineTo(canvas.width, BUCKET_TOP);\n   context.stroke();\n   context.restore();\n   \n   window.requestNextAnimationFrame(animate);\n}\n\n// Initialization................................................\n\nball.width = BALL_RADIUS*2;\nball.height = ball.width;\nball.left = LAUNCHPAD_X + LAUNCHPAD_WIDTH/2 - BALL_RADIUS;\nball.top = LAUNCHPAD_Y - ball.height/2 - BALL_RADIUS;\nlastBallPosition.left = ball.left;\nlastBallPosition.top = ball.top;\nball.radius = BALL_RADIUS;\n \ncontext.lineWidth = 0.5;\ncontext.strokeStyle = &#39;rgba(0,0,0,0.5)&#39;;\ncontext.shadowColor = &#39;rgba(0,0,0,0.5)&#39;;\ncontext.shadowOffsetX = 2;\ncontext.shadowOffsetY = 2;\ncontext.shadowBlur = 4; \ncontext.stroke();\n\nbucketImage.onload = function (e) {\n   bucket.left = BUCKET_LEFT;\n   bucket.top = BUCKET_TOP;\n   bucket.width = BUCKET_WIDTH;\n   bucket.height = BUCKET_HEIGHT;\n};\n\nanimate();\n\nbucketImage.src = &#39;data:image/png;base64,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&#39;;"};
    __preprocessorNames = {
      "html": "HTML",
      "css":  "CSS",
      "js":   "JS"
    };
    __pageType = "embed";
    __editable = false;
    __env = "prod";
  </script>

  <script src="./embed-530d0b718fdb8ad07ff215357b1acab0fa9237511d604c4c70cd752d1ee73460.js.下载"></script>





</body></html>